# Story 0.5: Configure External Services

**Epic:** Epic 0 - Project Initialization & Setup
**Story ID:** US-0.5
**Priority:** Critical (P0)
**Estimate:** 2 hours

---

## Status

**Ready**

---

## Story

**As a** developer,
**I want** to set up Google Cloud Document AI and LINE Messaging API,
**so that** OCR and notifications can function.

---

## Acceptance Criteria

1. Google Cloud Project created with billing enabled
2. Document AI API enabled in GCP
3. Receipt Parser processor created in Document AI
4. GCP Service account created with Document AI User role
5. Service account key downloaded as `gcp-credentials.json`
6. GCP credentials file added to `.gitignore`
7. Environment variables configured for GCP (PROJECT_ID, LOCATION, PROCESSOR_ID)
8. Test OCR call succeeds with sample receipt
9. LINE Official Account channel created for Messaging API
10. Channel access token obtained for LINE Messaging API
11. Environment variables configured for LINE Messaging (CHANNEL_ACCESS_TOKEN, CHANNEL_SECRET)
12. Test LINE message sends successfully

---

## Tasks / Subtasks

- [ ] **Task 1: Create Google Cloud Project** (AC: 1)

  - [ ] Go to Google Cloud Console: https://console.cloud.google.com/
  - [ ] Create new project or select existing
  - [ ] Note Project ID
  - [ ] Enable billing for the project
  - [ ] Verify billing account linked

- [ ] **Task 2: Enable Document AI API** (AC: 2)

  - [ ] In GCP Console, go to APIs & Services
  - [ ] Click "Enable APIs and Services"
  - [ ] Search for "Document AI API"
  - [ ] Click "Enable"
  - [ ] Wait for API to be enabled

- [ ] **Task 3: Create Receipt Parser processor** (AC: 3)

  - [ ] Go to Document AI in GCP Console
  - [ ] Click "Create Processor"
  - [ ] Select "Receipt Parser" processor type
  - [ ] Choose location: US, EU, or asia-northeast1 (for Thailand)
  - [ ] Note Processor ID
  - [ ] Processor should show as "Active"

- [ ] **Task 4: Create service account** (AC: 4)

  - [ ] Go to IAM & Admin → Service Accounts
  - [ ] Click "Create Service Account"
  - [ ] Name: "household-bills-docai"
  - [ ] Grant role: "Document AI API User"
  - [ ] Click "Done"

- [ ] **Task 5: Download service account key** (AC: 5, 6)

  - [ ] Click on created service account
  - [ ] Go to "Keys" tab
  - [ ] Click "Add Key" → "Create new key"
  - [ ] Choose JSON format
  - [ ] Download file and rename to `gcp-credentials.json`
  - [ ] Move file to project root
  - [ ] Verify `gcp-credentials.json` in `.gitignore`

- [ ] **Task 6: Configure GCP environment variables** (AC: 7)

  - [ ] Add to `.env.local`:
    - [ ] `GCP_PROJECT_ID="<your-project-id>"`
    - [ ] `GCP_LOCATION="us"` (or asia-northeast1 for Thailand)
    - [ ] `GCP_PROCESSOR_ID="<processor-id>"`
    - [ ] `GOOGLE_APPLICATION_CREDENTIALS="./gcp-credentials.json"`

- [ ] **Task 7: Test Document AI OCR** (AC: 8)

  - [ ] Create test script: `scripts/test-ocr.ts`
  - [ ] Use sample receipt image
  - [ ] Call Document AI API
  - [ ] Verify extraction returns data
  - [ ] Check confidence scores
  - [ ] Log extracted fields

- [ ] **Task 8: Create LINE Official Account** (AC: 9)

  - [ ] Go to LINE Developers Console
  - [ ] Create Messaging API channel
  - [ ] Note Channel ID
  - [ ] Note Channel Secret
  - [ ] Enable "Use webhooks" (for future)

- [ ] **Task 9: Get LINE Messaging API token** (AC: 10)

  - [ ] In Messaging API channel settings
  - [ ] Go to "Messaging API" tab
  - [ ] Click "Issue" for Channel access token
  - [ ] Copy long-lived channel access token
  - [ ] Store securely for environment variables

- [ ] **Task 10: Configure LINE Messaging environment variables** (AC: 11)

  - [ ] Add to `.env.local`:
    - [ ] `LINE_CHANNEL_ACCESS_TOKEN="<channel-access-token>"`
    - [ ] `LINE_CHANNEL_SECRET="<channel-secret>"`

- [ ] **Task 11: Test LINE Messaging API** (AC: 12)
  - [ ] Create test script: `scripts/test-line-message.ts`
  - [ ] Use LINE Messaging API to send test message
  - [ ] Send to your LINE user ID (from profile)
  - [ ] Verify message received in LINE app
  - [ ] Check API response status

---

## Dev Notes

### Google Cloud Document AI Setup

**Test OCR Script (scripts/test-ocr.ts):**

```typescript
import { DocumentProcessorServiceClient } from "@google-cloud/documentai";
import fs from "fs";

async function testOCR() {
  const client = new DocumentProcessorServiceClient({
    keyFilename: "./gcp-credentials.json",
  });

  const projectId = process.env.GCP_PROJECT_ID!;
  const location = process.env.GCP_LOCATION || "us";
  const processorId = process.env.GCP_PROCESSOR_ID!;

  const name = `projects/${projectId}/locations/${location}/processors/${processorId}`;

  // Use a sample receipt image
  const imageFile = fs.readFileSync("./tests/fixtures/sample-receipt.jpg");
  const encodedImage = Buffer.from(imageFile).toString("base64");

  const request = {
    name,
    rawDocument: {
      content: encodedImage,
      mimeType: "image/jpeg",
    },
  };

  try {
    const [result] = await client.processDocument(request);
    const { document } = result;

    console.log("✅ Document AI OCR Test Successful!");
    console.log("Extracted entities:");

    document?.entities?.forEach((entity) => {
      console.log(
        `- ${entity.type}: ${entity.mentionText} (confidence: ${entity.confidence})`
      );
    });

    const totalAmount = document?.entities?.find(
      (e) => e.type === "total_amount"
    );
    const receiptDate = document?.entities?.find(
      (e) => e.type === "receipt_date"
    );

    console.log("\nKey fields:");
    console.log(`Total: ${totalAmount?.mentionText || "N/A"}`);
    console.log(`Date: ${receiptDate?.mentionText || "N/A"}`);
  } catch (error) {
    console.error("❌ Document AI OCR Test Failed:", error);
    process.exit(1);
  }
}

testOCR();
```

**Run test:**

```bash
tsx scripts/test-ocr.ts
```

### LINE Messaging API Setup

**Test LINE Message Script (scripts/test-line-message.ts):**

```typescript
import axios from "axios";

async function testLineMessage() {
  const channelAccessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN!;
  const yourLineUserId = "YOUR_LINE_USER_ID"; // Get from LINE profile or LIFF

  try {
    const response = await axios.post(
      "https://api.line.me/v2/bot/message/push",
      {
        to: yourLineUserId,
        messages: [
          {
            type: "text",
            text: "✅ LINE Messaging API test successful! Your household bills app is ready to send notifications.",
          },
        ],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${channelAccessToken}`,
        },
      }
    );

    console.log("✅ LINE Message Test Successful!");
    console.log("Response:", response.data);
    console.log("Check your LINE app for the test message.");
  } catch (error: any) {
    console.error(
      "❌ LINE Message Test Failed:",
      error.response?.data || error.message
    );
    process.exit(1);
  }
}

testLineMessage();
```

**Run test:**

```bash
tsx scripts/test-line-message.ts
```

### Google Cloud Free Tier

**Document AI Pricing:**

- Free tier: 1,000 pages/month
- After free tier: $1.50 per 1,000 pages
- Sufficient for hackathon and MVP development

**Billing Alert (Recommended):**

1. Go to GCP Console → Billing
2. Set budget alert at $5
3. Get email notification before charges occur

### LINE Messaging API Limits

**Free tier:**

- 500 messages/month for free
- After limit: Paid plan required
- Sufficient for development and small user base

**Rate limits:**

- Push messages: 500 requests/second
- Multicast: 100 requests/second
- Sufficient for MVP scale

### Getting Your LINE User ID

**Option 1: From LINE Profile:**

1. Open LINE app
2. Go to Settings → Profile
3. Copy User ID (if visible)

**Option 2: From LIFF (after auth setup):**

```typescript
import liff from "@line/liff";

liff.init({ liffId: process.env.NEXT_PUBLIC_LINE_LIFF_ID! });
const userId = liff.getContext()?.userId;
```

**Option 3: Webhook (after receiving message):**

- User sends message to your Official Account
- Webhook receives event with userId

### Environment Variables Summary

```bash
# Google Cloud Document AI
GCP_PROJECT_ID="your-gcp-project-id"
GCP_LOCATION="us"  # or "asia-northeast1" for Thailand
GCP_PROCESSOR_ID="your-processor-id"
GOOGLE_APPLICATION_CREDENTIALS="./gcp-credentials.json"

# LINE Messaging API (Official Account)
LINE_CHANNEL_ACCESS_TOKEN="your-channel-access-token"
LINE_CHANNEL_SECRET="your-channel-secret"
```

### Troubleshooting

**Google Cloud Issues:**

- "Permission denied": Verify service account has "Document AI API User" role
- "API not enabled": Re-enable Document AI API in console
- "Billing required": Link billing account to project
- "Invalid credentials": Check gcp-credentials.json path and format

**LINE Messaging Issues:**

- "Invalid channel access token": Regenerate token in console
- "Message not delivered": Check LINE user ID format
- "Rate limit exceeded": Wait 1 minute, check free tier limits
- "Forbidden": Verify Official Account is not blocked by user

### Testing

**Document AI Test:**

1. Place sample receipt in `tests/fixtures/sample-receipt.jpg`
2. Run `tsx scripts/test-ocr.ts`
3. Verify extracted entities printed to console
4. Check confidence scores ≥ 60%

**LINE Messaging Test:**

1. Get your LINE User ID
2. Update `scripts/test-line-message.ts` with your ID
3. Run `tsx scripts/test-line-message.ts`
4. Check LINE app for test message
5. Verify API response shows success

**No automated tests** - Manual API verification only

---

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-10-03 | 1.0     | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
