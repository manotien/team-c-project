# Story 0.7: Create Environment Configuration

**Epic:** Epic 0 - Project Initialization & Setup
**Story ID:** US-0.7
**Priority:** Critical (P0)
**Estimate:** 1 hour

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to create comprehensive environment variable documentation,
**so that** all team members can configure their local environment correctly.

---

## Acceptance Criteria

1. `.env.example` file created with all required variables (placeholder values)
2. `.env.local` file created (gitignored) with actual development values
3. README.md includes environment setup section
4. All environment variables documented with purpose, example, and required/optional status
5. Validation script created at `scripts/validate-env.ts`
6. Validation runs on `pnpm dev` startup
7. Missing variables error with helpful messages
8. `.env.local` in `.gitignore` verified

---

## Tasks / Subtasks

- [ ] **Task 1: Create .env.example template** (AC: 1, 4)
  - [ ] Create `.env.example` file
  - [ ] Add all required environment variables with placeholder values
  - [ ] Add comments explaining each variable
  - [ ] Group variables by category (Database, Auth, LINE, GCP, etc.)
  - [ ] Mark optional variables clearly

- [ ] **Task 2: Create .env.local for development** (AC: 2, 8)
  - [ ] Copy `.env.example` to `.env.local`
  - [ ] Fill in actual development values
  - [ ] Verify `.env.local` in `.gitignore`
  - [ ] Test loading environment variables in Next.js

- [ ] **Task 3: Document environment setup in README** (AC: 3)
  - [ ] Add "Environment Variables" section to README.md
  - [ ] Link to `.env.example`
  - [ ] Provide setup instructions
  - [ ] Document how to generate secrets
  - [ ] Add troubleshooting for missing variables

- [ ] **Task 4: Create environment validation script** (AC: 5, 6, 7)
  - [ ] Create `scripts/validate-env.ts`
  - [ ] Check for required variables
  - [ ] Provide helpful error messages
  - [ ] Exit with error code if validation fails
  - [ ] Add validation to `dev` script in package.json

- [ ] **Task 5: Update package.json dev script** (AC: 6)
  - [ ] Modify `"dev"` script to run validation first
  - [ ] Change to: `"dev": "tsx scripts/validate-env.ts && next dev"`
  - [ ] Test that validation runs on `pnpm dev`

- [ ] **Task 6: Test environment configuration**
  - [ ] Remove one required variable from `.env.local`
  - [ ] Run `pnpm dev` - should fail with clear error
  - [ ] Restore variable
  - [ ] Run `pnpm dev` - should succeed
  - [ ] Verify all services can access their env vars

---

## Dev Notes

### Complete .env.example Template

```.env
# ==========================================
# Database Configuration
# ==========================================
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/household_bills"

# ==========================================
# NextAuth Configuration
# ==========================================
# Generate secret with: openssl rand -base64 32
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-nextauth-secret-generate-with-openssl"

# ==========================================
# LINE LIFF & OAuth Configuration
# ==========================================
# Get these from LINE Developers Console
NEXT_PUBLIC_LINE_LIFF_ID="your-liff-id"
LINE_CLIENT_ID="your-line-client-id"
LINE_CLIENT_SECRET="your-line-client-secret"

# ==========================================
# LINE Messaging API Configuration
# ==========================================
# Get these from LINE Official Account settings
LINE_CHANNEL_ACCESS_TOKEN="your-line-channel-access-token"
LINE_CHANNEL_SECRET="your-line-channel-secret"

# ==========================================
# Redis Configuration
# ==========================================
REDIS_HOST="localhost"
REDIS_PORT="6379"
REDIS_PASSWORD=""

# ==========================================
# Google Cloud Document AI
# ==========================================
# Get these from Google Cloud Console
GCP_PROJECT_ID="your-gcp-project-id"
GCP_LOCATION="us"  # or "asia-northeast1" for Thailand
GCP_PROCESSOR_ID="your-processor-id"
GOOGLE_APPLICATION_CREDENTIALS="./gcp-credentials.json"

# ==========================================
# File Upload Configuration
# ==========================================
UPLOAD_DIR="./public/uploads"
NEXT_PUBLIC_UPLOAD_URL="/uploads"

# ==========================================
# Development Flags (Optional)
# ==========================================
NEXT_PUBLIC_ENABLE_OCR_DEBUG="false"
NEXT_PUBLIC_DEMO_MODE="false"
```

### Environment Validation Script (scripts/validate-env.ts)

```typescript
#!/usr/bin/env tsx

const requiredEnvVars = [
  'DATABASE_URL',
  'NEXTAUTH_URL',
  'NEXTAUTH_SECRET',
  'LINE_CLIENT_ID',
  'LINE_CLIENT_SECRET',
  'NEXT_PUBLIC_LINE_LIFF_ID',
  'LINE_CHANNEL_ACCESS_TOKEN',
  'LINE_CHANNEL_SECRET',
  'GCP_PROJECT_ID',
  'GCP_LOCATION',
  'GCP_PROCESSOR_ID',
  'REDIS_HOST',
  'REDIS_PORT',
] as const;

const optionalEnvVars = [
  'REDIS_PASSWORD',
  'UPLOAD_DIR',
  'NEXT_PUBLIC_UPLOAD_URL',
  'NEXT_PUBLIC_ENABLE_OCR_DEBUG',
  'NEXT_PUBLIC_DEMO_MODE',
] as const;

function validateEnv() {
  console.log('ðŸ” Validating environment variables...\n');

  const missing: string[] = [];
  const warnings: string[] = [];

  // Check required variables
  requiredEnvVars.forEach((varName) => {
    if (!process.env[varName]) {
      missing.push(varName);
    }
  });

  // Check GOOGLE_APPLICATION_CREDENTIALS file exists
  const gcp Creds = process.env.GOOGLE_APPLICATION_CREDENTIALS;
  if (gcpCreds && !require('fs').existsSync(gcpCreds)) {
    warnings.push(`GOOGLE_APPLICATION_CREDENTIALS file not found: ${gcpCreds}`);
  }

  // Check for weak NEXTAUTH_SECRET
  const nextAuthSecret = process.env.NEXTAUTH_SECRET;
  if (nextAuthSecret && nextAuthSecret.length < 32) {
    warnings.push('NEXTAUTH_SECRET should be at least 32 characters (run: openssl rand -base64 32)');
  }

  // Report results
  if (missing.length > 0) {
    console.error('âŒ Missing required environment variables:\n');
    missing.forEach((varName) => {
      console.error(`   - ${varName}`);
    });
    console.error('\nðŸ“ Copy .env.example to .env.local and fill in the values.\n');
    process.exit(1);
  }

  if (warnings.length > 0) {
    console.warn('âš ï¸  Warnings:\n');
    warnings.forEach((warning) => {
      console.warn(`   - ${warning}`);
    });
    console.warn('');
  }

  console.log('âœ… All required environment variables are set!\n');
}

validateEnv();
```

### README.md Environment Section

```markdown
## Environment Variables

This project requires several environment variables to function properly.

### Setup

1. Copy the example environment file:
   ```bash
   cp .env.example .env.local
   ```

2. Fill in the required values in `.env.local`:
   - **Database:** Should work with default PostgreSQL settings
   - **NextAuth Secret:** Generate with `openssl rand -base64 32`
   - **LINE Credentials:** Get from [LINE Developers Console](https://developers.line.biz/console/)
   - **Google Cloud:** Get from [Google Cloud Console](https://console.cloud.google.com/)

3. Download Google Cloud credentials:
   - Create service account in GCP
   - Download JSON key as `gcp-credentials.json`
   - Place in project root

### Required Variables

| Variable | Description | How to Get |
|----------|-------------|------------|
| `DATABASE_URL` | PostgreSQL connection string | Use local: `postgresql://postgres:postgres@localhost:5432/household_bills` |
| `NEXTAUTH_SECRET` | NextAuth encryption secret | Generate: `openssl rand -base64 32` |
| `LINE_CLIENT_ID` | LINE Login channel ID | LINE Developers Console â†’ Channel Basic Settings |
| `LINE_CLIENT_SECRET` | LINE Login channel secret | LINE Developers Console â†’ Channel Basic Settings |
| `NEXT_PUBLIC_LINE_LIFF_ID` | LIFF app ID | LINE Developers Console â†’ LIFF tab |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging API token | LINE Developers Console â†’ Messaging API tab |
| `GCP_PROJECT_ID` | Google Cloud project ID | Google Cloud Console â†’ Project Info |
| `GCP_PROCESSOR_ID` | Document AI processor ID | Google Cloud Console â†’ Document AI â†’ Processors |

See `.env.example` for complete list and descriptions.

### Validation

Environment variables are validated automatically when you run:
```bash
pnpm dev
```

If any required variables are missing, you'll see a helpful error message.
```

### Package.json Dev Script Update

```json
{
  "scripts": {
    "dev": "tsx scripts/validate-env.ts && next dev",
    "build": "tsx scripts/validate-env.ts && next build",
    ...
  }
}
```

### Testing

**Test validation with missing variable:**
1. Rename `.env.local` temporarily: `mv .env.local .env.local.backup`
2. Run `pnpm dev`
3. Should see error listing missing variables
4. Restore: `mv .env.local.backup .env.local`

**Test validation with all variables:**
1. Ensure `.env.local` has all required variables
2. Run `pnpm dev`
3. Should see "âœ… All required environment variables are set!"
4. Dev server should start

**Test weak secret warning:**
1. Set `NEXTAUTH_SECRET="weak"` in `.env.local`
2. Run `pnpm dev`
3. Should see warning about weak secret
4. But dev server should still start (warning only)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
