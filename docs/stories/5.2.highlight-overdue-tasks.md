# Story 5.2: Highlight Overdue Tasks

**Epic:** EPIC-5 - Dashboard & Tracking
**Story ID:** US-5.2
**Priority:** Critical (P0)
**Status:** Draft

---

## Story

**As a** user,
**I want** to see overdue tasks highlighted so I know what's urgent,
**so that** I can prioritize payments that are already late

---

## Acceptance Criteria

1. Tasks with `dueDate < current date` marked as overdue
2. Overdue tasks displayed at top of upcoming tasks (highest priority)
3. Visual indicators for overdue status:
   - Red border or background color
   - "OVERDUE" badge in red
   - Warning icon (⚠️ or similar)
   - Days overdue count: "3 days overdue"
4. Overdue tasks still shown even if status = PAID (in history)
5. Separate "Overdue" section above "Upcoming Tasks" (optional)
6. Count badge in navigation: "Overdue (3)"

---

## Tasks / Subtasks

- [ ] Implement overdue detection logic (AC: 1)
  - [ ] Create `isOverdue` helper function
  - [ ] Calculate if `dueDate < new Date()`
  - [ ] Handle timezone consistency (UTC)
  - [ ] Export from date helpers utility

- [ ] Update Prisma query to prioritize overdue tasks (AC: 2)
  - [ ] Query overdue tasks separately
  - [ ] Sort overdue to top of list
  - [ ] Combine with upcoming tasks
  - [ ] Alternative: Use single query with orderBy logic

- [ ] Calculate days overdue (AC: 3d)
  - [ ] Create `getDaysOverdue` helper function
  - [ ] Calculate difference between now and dueDate
  - [ ] Return number of days as integer
  - [ ] Handle edge cases (same day, negative values)

- [ ] Add visual styling for overdue tasks (AC: 3a, 3b, 3c)
  - [ ] Update TaskCard component with overdue prop
  - [ ] Apply red border: `border-red-500`
  - [ ] Apply red background: `bg-red-50`
  - [ ] Add "OVERDUE" badge with red variant
  - [ ] Add warning icon (⚠️) next to badge
  - [ ] Display days overdue count

- [ ] Create separate Overdue section (AC: 5 - optional)
  - [ ] Add "Overdue Tasks" heading above Upcoming
  - [ ] Group overdue tasks in separate section
  - [ ] Apply distinct styling to section
  - [ ] Show overdue count in heading

- [ ] Add overdue count badge to navigation (AC: 6)
  - [ ] Query count of overdue tasks
  - [ ] Display badge in nav: "Dashboard" or "Overdue (3)"
  - [ ] Update badge color to red/warning
  - [ ] Update count dynamically when tasks change

- [ ] Handle overdue paid tasks in history (AC: 4)
  - [ ] Include overdue PAID tasks in history view
  - [ ] Show "Was overdue" indicator on paid tasks
  - [ ] Display how many days it was paid late
  - [ ] Coordinate with Epic 4 (Task History)

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: Next.js React Server Components + Client Components
- Database: Prisma ORM
- Date utilities: date-fns
- UI: shadcn/ui Badge component
- Styling: Tailwind CSS (red color scheme)

**Integration Points:**
- US-5.1: Extends upcoming tasks component
- Epic 4 (Task History): Overdue paid tasks display
- Dashboard navigation: Overdue count badge
- Epic 8 (Icons): Warning icon display

**Key Implementation Details:**

**Overdue Helper Functions (`lib/utils/dateHelpers.ts`):**
```typescript
import { isBefore, differenceInDays } from 'date-fns';

export function isOverdue(dueDate: Date): boolean {
  const now = new Date();
  return isBefore(dueDate, now);
}

export function getDaysOverdue(dueDate: Date): number {
  if (!isOverdue(dueDate)) return 0;

  const now = new Date();
  return differenceInDays(now, dueDate);
}
```

**Prisma Query for Overdue Tasks:**
```typescript
// Option 1: Separate query for overdue tasks
const overdueTasks = await prisma.task.findMany({
  where: {
    userId: session.user.id,
    status: 'UNPAID',
    dueDate: {
      lt: new Date()
    }
  },
  include: { bill: true },
  orderBy: { dueDate: 'asc' }
});

const upcomingTasks = await prisma.task.findMany({
  where: {
    userId: session.user.id,
    status: 'UNPAID',
    dueDate: {
      gte: new Date()
    }
  },
  include: { bill: true },
  orderBy: { dueDate: 'asc' },
  take: 10
});

// Combine: overdue first, then upcoming
const allTasks = [...overdueTasks, ...upcomingTasks];

// Option 2: Single query with conditional sorting
const tasks = await prisma.task.findMany({
  where: {
    userId: session.user.id,
    status: 'UNPAID'
  },
  include: { bill: true },
  orderBy: [
    { dueDate: 'asc' }
  ],
  take: 10
});

// Sort in application layer: overdue first
const sortedTasks = tasks.sort((a, b) => {
  const aOverdue = isOverdue(a.dueDate);
  const bOverdue = isOverdue(b.dueDate);

  if (aOverdue && !bOverdue) return -1;
  if (!aOverdue && bOverdue) return 1;
  return a.dueDate.getTime() - b.dueDate.getTime();
});
```

**Updated TaskCard Component with Overdue Styling:**
```typescript
'use client';

import Link from 'next/link';
import { formatDistanceToNow, format } from 'date-fns';
import { Badge } from '@/components/ui/badge';
import { BillTypeIcon } from '@/components/bills/BillTypeIcon';
import { isDueSoon, isOverdue, getDaysOverdue } from '@/lib/utils/dateHelpers';
import { AlertTriangle } from 'lucide-react';
import type { Task, Bill } from '@prisma/client';

interface TaskCardProps {
  task: Task & { bill: Bill };
}

export function TaskCard({ task }: TaskCardProps) {
  const overdue = isOverdue(task.dueDate);
  const dueSoon = !overdue && isDueSoon(task.dueDate);
  const daysOverdue = getDaysOverdue(task.dueDate);

  const relativeDate = formatDistanceToNow(task.dueDate, { addSuffix: true });
  const absoluteDate = format(task.dueDate, 'MMM dd');

  return (
    <Link href={`/tasks/${task.id}`}>
      <div className={`
        border rounded-lg p-4 hover:bg-accent transition-colors cursor-pointer
        ${overdue ? 'border-red-500 bg-red-50' : ''}
      `}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <BillTypeIcon type={task.bill.billType} size="md" />
            <div>
              <h3 className="font-semibold">
                {task.bill.vendor || 'Bill Payment'}
              </h3>
              <p className="text-sm text-muted-foreground">
                {overdue ? (
                  <span className="text-red-600 font-medium">
                    {daysOverdue} {daysOverdue === 1 ? 'day' : 'days'} overdue
                  </span>
                ) : (
                  <>Due {relativeDate} ({absoluteDate})</>
                )}
              </p>
            </div>
          </div>
          <div className="text-right">
            <p className="font-bold text-lg">
              ฿{task.bill.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
            </p>
            {overdue && (
              <Badge variant="destructive" className="mt-1 gap-1">
                <AlertTriangle className="w-3 h-3" />
                OVERDUE
              </Badge>
            )}
            {dueSoon && (
              <Badge variant="warning" className="mt-1">
                Due Soon
              </Badge>
            )}
          </div>
        </div>
      </div>
    </Link>
  );
}
```

**Dashboard with Separate Overdue Section:**
```typescript
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { TaskCard } from '@/components/tasks/TaskCard';

export async function DashboardTasks() {
  const session = await getServerSession(authOptions);
  if (!session) return null;

  const overdueTasks = await prisma.task.findMany({
    where: {
      userId: session.user.id,
      status: 'UNPAID',
      dueDate: { lt: new Date() }
    },
    include: { bill: true },
    orderBy: { dueDate: 'asc' }
  });

  const upcomingTasks = await prisma.task.findMany({
    where: {
      userId: session.user.id,
      status: 'UNPAID',
      dueDate: { gte: new Date() }
    },
    include: { bill: true },
    orderBy: { dueDate: 'asc' },
    take: 10
  });

  return (
    <div className="space-y-8">
      {/* Overdue Section */}
      {overdueTasks.length > 0 && (
        <section>
          <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
            <AlertTriangle className="w-6 h-6" />
            Overdue Tasks ({overdueTasks.length})
          </h2>
          <div className="space-y-3">
            {overdueTasks.map(task => (
              <TaskCard key={task.id} task={task} />
            ))}
          </div>
        </section>
      )}

      {/* Upcoming Section */}
      <section>
        <h2 className="text-2xl font-bold mb-4">Upcoming Tasks</h2>
        {upcomingTasks.length === 0 ? (
          <p className="text-muted-foreground">No upcoming bills</p>
        ) : (
          <div className="space-y-3">
            {upcomingTasks.map(task => (
              <TaskCard key={task.id} task={task} />
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
```

**Navigation Badge for Overdue Count:**
```typescript
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { Badge } from '@/components/ui/badge';

export async function DashboardNav() {
  const session = await getServerSession(authOptions);
  if (!session) return null;

  const overdueCount = await prisma.task.count({
    where: {
      userId: session.user.id,
      status: 'UNPAID',
      dueDate: { lt: new Date() }
    }
  });

  return (
    <nav>
      <a href="/dashboard" className="flex items-center gap-2">
        Dashboard
        {overdueCount > 0 && (
          <Badge variant="destructive" className="ml-1">
            {overdueCount}
          </Badge>
        )}
      </a>
    </nav>
  );
}
```

**Timezone Handling:**
```typescript
// Store all dates in UTC in database
// Convert to user timezone for display only

// When comparing dates, always use UTC
const now = new Date(); // Already in UTC when comparing
const isOverdue = dueDate < now;

// For display, optionally convert to user timezone
import { formatInTimeZone } from 'date-fns-tz';
const displayDate = formatInTimeZone(dueDate, 'Asia/Bangkok', 'MMM dd, yyyy');
```

**CSS Tailwind Classes for Overdue:**
- Border: `border-red-500`
- Background: `bg-red-50`
- Text: `text-red-600`
- Badge: `variant="destructive"` (red background)

### Dependencies

**Upstream Dependencies:**
- US-5.1: Extends upcoming tasks functionality
- Epic 2 (Task Creation): Tasks with due dates

**Downstream Dependencies:**
- Epic 4 (Task History): Overdue paid tasks display

### Testing

**Test Location:** `__tests__/lib/utils/dateHelpers.test.ts` and `__tests__/components/tasks/TaskCard.test.tsx`

**Testing Standards:**
- Unit tests for overdue helper functions
- Unit tests for TaskCard overdue styling
- Integration tests for dashboard queries
- E2E test for overdue display
- Test timezone edge cases

**Testing Frameworks:**
- Jest for unit tests
- React Testing Library for component tests
- Playwright for E2E tests
- Mock Prisma client for database queries

**Specific Requirements:**
- Test isOverdue returns true for past dates
- Test isOverdue returns false for future dates
- Test isOverdue handles today's date correctly
- Test getDaysOverdue calculates correctly
- Test getDaysOverdue returns 0 for non-overdue
- Test TaskCard applies red border when overdue
- Test TaskCard applies red background when overdue
- Test TaskCard shows "OVERDUE" badge
- Test TaskCard shows warning icon
- Test TaskCard displays days overdue count
- Test overdue tasks appear before upcoming tasks
- Test separate overdue section displays correctly
- Test navigation badge shows correct count
- Test navigation badge hidden when count = 0
- Test overdue paid tasks in history (AC: 4)
- Mock getServerSession for authenticated tests
- Mock Prisma with overdue and upcoming tasks

**Test Scenarios:**
1. **Task overdue by 1 day**: Shows "1 day overdue"
2. **Task overdue by 3 days**: Shows "3 days overdue"
3. **Task due today**: Not marked as overdue (edge case decision)
4. **Task due tomorrow**: Not overdue, shows "Due Soon"
5. **Mixed overdue and upcoming**: Overdue tasks at top
6. **All tasks overdue**: Only overdue section shown
7. **No overdue tasks**: Overdue section hidden
8. **Navigation badge**: Shows count when overdue tasks exist
9. **Timezone edge case**: Midnight UTC vs local time
10. **Paid overdue task**: Shows in history with "Was overdue" indicator

**Mock Data Example:**
```typescript
const mockOverdueTask = {
  id: '1',
  userId: 'user1',
  status: 'UNPAID',
  dueDate: subDays(new Date(), 3), // 3 days ago
  bill: {
    id: 'bill1',
    vendor: 'MEA',
    amount: 1500.00,
    billType: 'ELECTRIC'
  }
};
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation from Epic 5 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
