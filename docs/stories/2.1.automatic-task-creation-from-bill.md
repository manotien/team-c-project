# US-2.1: Automatic Task Creation from Bill

**Story ID:** US-2.1
**Epic:** [Epic 2: Task Creation](epic-2-task-creation.md)
**Priority:** Critical (P0)
**Story Points:** 5
**Status:** Ready for Development

---

## User Story

**As a** user
**I want to** create a task linked to a bill automatically when I add a bill
**So that** I can track my payment responsibility without extra steps

---

## Acceptance Criteria

- [ ] Task automatically created when bill is saved (POST /api/bills)
- [ ] Task title auto-generated: "Pay {vendor} bill"
- [ ] Task due date copied from bill due date
- [ ] Task status set to UNPAID by default
- [ ] Task.userId set to current authenticated user
- [ ] Task.billId references the bill record (1:1 relationship)
- [ ] Task creation happens in same database transaction as bill
- [ ] Transaction rolled back if task creation fails
- [ ] Success message shows "Bill and task created"

---

## Technical Implementation

### Database Schema
```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY,
  bill_id UUID NOT NULL UNIQUE REFERENCES bills(id),
  user_id UUID NOT NULL REFERENCES users(id),
  title VARCHAR(500) NOT NULL,
  status VARCHAR(50) NOT NULL CHECK (status IN ('UNPAID', 'PAID')),
  due_date TIMESTAMP WITH TIME ZONE NOT NULL,
  paid_at TIMESTAMP WITH TIME ZONE,
  payment_proof_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
```

### Backend Implementation
**File:** `app/api/bills/route.ts`

```typescript
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { prisma } from '@/lib/prisma';

export async function POST(req: Request) {
  const session = await getServerSession(authOptions);

  if (!session?.user?.id) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const data = await req.json();

  try {
    // Use transaction to ensure atomicity
    const result = await prisma.$transaction(async (tx) => {
      // Create bill
      const bill = await tx.bill.create({
        data: {
          ...data,
          userId: session.user.id
        }
      });

      // Create associated task
      const task = await tx.task.create({
        data: {
          billId: bill.id,
          userId: session.user.id,
          title: `Pay ${bill.vendor} bill`,
          status: 'UNPAID',
          dueDate: bill.dueDate
        }
      });

      return { bill, task };
    });

    return NextResponse.json({
      message: 'Bill and task created',
      ...result
    });
  } catch (error) {
    console.error('Error creating bill and task:', error);
    return NextResponse.json(
      { error: 'Failed to create bill and task' },
      { status: 500 }
    );
  }
}
```

### Prisma Schema
**File:** `prisma/schema.prisma`

```prisma
model Task {
  id               String    @id @default(uuid())
  billId           String    @unique
  userId           String
  title            String
  status           String    // 'UNPAID' | 'PAID'
  dueDate          DateTime
  paidAt           DateTime?
  paymentProofUrl  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  bill             Bill      @relation(fields: [billId], references: [id])
  user             User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Bill {
  id               String    @id @default(uuid())
  userId           String
  vendor           String
  amount           Decimal
  dueDate          DateTime
  type             String
  photoUrl         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  task             Task?
  user             User      @relation(fields: [userId], references: [id])

  @@index([userId])
}
```

---

## Technical Notes

- **Atomicity:** Use Prisma `$transaction()` to ensure both bill and task are created together or neither is created
- **1:1 Relationship:** UNIQUE constraint on `billId` enforces one task per bill
- **Auto-assignment:** No assignment dropdown needed - user who creates bill owns the task
- **Task Model Fields:** `billId` (unique), `userId`, `title`, `status`, `dueDate`

---

## Testing Requirements

### Unit Tests
- [ ] Test task creation with bill in transaction
- [ ] Test transaction rollback on task creation failure
- [ ] Test auto-generated task title format
- [ ] Test task status defaults to UNPAID
- [ ] Test due date copied from bill

### Integration Tests
- [ ] Test POST /api/bills creates both bill and task
- [ ] Test task-bill 1:1 relationship integrity
- [ ] Test userId assignment

### E2E Tests
- [ ] Create bill via UI â†’ verify task created in database
- [ ] Verify task appears on dashboard after bill creation
- [ ] Test transaction rollback on error

---

## Dependencies

**Upstream:**
- Epic 1 (Bill Capture): Bill creation API must exist
- Epic 9 (Login & Auth): Authenticated user session required

**Downstream:**
- Epic 3 (Notifications): Task creation may trigger LINE notification
- Epic 4 (Task Actions): Task status updates (mark paid)
- Epic 5 (Dashboard): Task display and filtering

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Database transaction implemented and tested
- [ ] Error handling for transaction failures
- [ ] Task model created in Prisma schema
- [ ] Database migration applied
- [ ] Unit tests passing
- [ ] Integration tests passing
- [ ] E2E test passing
- [ ] Code reviewed and merged

---

## Risk Assessment

**Primary Risk:** Task creation fails but bill succeeds (data inconsistency)
**Mitigation:** Prisma transaction ensures atomicity - both succeed or both fail

**Secondary Risk:** Performance impact of transaction
**Mitigation:** Transaction only involves 2 writes, minimal performance impact

---

## Notes

- This is **critical path** for 4-hour MVP demo
- Single-user architecture simplifies assignment logic
- No OVERDUE status enum - calculated at runtime based on due date
- Success message confirms both bill and task creation to user
