# Story 7.2: Specify Recurrence Scheduling Details

**Epic:** [Epic 7: Recurring Reminders](epic-7-recurring-reminders.md)
**Story ID:** US-7.2
**Priority:** Medium (P2)
**Status:** Draft

---

## Story

**As a** user,
**I want** to specify details like day of week or day of month,
**so that** recurring bills are created on the correct date.

---

## Acceptance Criteria

1. **For Weekly recurrence:**
   - Show day-of-week selector (Mon, Tue, Wed, etc.)
   - Store in `recurrence.dayOfWeek` (0-6, 0=Sunday)
   - Example: "Every Monday"

2. **For Monthly recurrence:**
   - Show day-of-month input (1-31)
   - Store in `recurrence.dayOfMonth` (1-31)
   - Handle edge cases (e.g., day 31 in February → last day of month)
   - Example: "Every 15th of the month"

3. **For Yearly recurrence:**
   - Show month selector (Jan-Dec) and day input
   - Store in `recurrence.monthOfYear` (1-12) and `recurrence.dayOfMonth`
   - Example: "Every January 1st"

4. Preview text shown: "Next bill will be created on: [date]"
5. Validation: Ensure day/month values are valid

---

## Tasks / Subtasks

- [ ] Implement weekly recurrence details (AC: 1)
  - [ ] Create day-of-week selector component (Mon-Sun)
  - [ ] Store selected day as 0-6 (0=Sunday, 1=Monday, etc.)
  - [ ] Update RecurrenceSelector to show day selector when Weekly selected
  - [ ] Display preview: "Every [day name]" or "Every 2 [day names]"

- [ ] Implement monthly recurrence details (AC: 2)
  - [ ] Add day-of-month number input (1-31)
  - [ ] Validate day number is within valid range
  - [ ] Handle edge cases (day 31 for months with <31 days)
  - [ ] Update RecurrenceSelector to show day input when Monthly selected
  - [ ] Display preview: "Every 15th of the month" or "Every 2 months on the 15th"

- [ ] Implement yearly recurrence details (AC: 3)
  - [ ] Add month selector dropdown (January-December)
  - [ ] Add day-of-month input for yearly recurrence
  - [ ] Store month as 1-12 (1=January, 12=December)
  - [ ] Validate day is valid for selected month
  - [ ] Display preview: "Every January 1st" or "Every 2 years on January 1st"

- [ ] Implement preview calculation (AC: 4)
  - [ ] Create `calculateNextRecurrenceDate()` function
  - [ ] Display preview text showing next bill creation date
  - [ ] Update preview when any recurrence setting changes
  - [ ] Format preview date clearly (e.g., "Monday, October 15, 2025")
  - [ ] Handle calculation for all recurrence types

- [ ] Add validation for scheduling details (AC: 5)
  - [ ] Validate dayOfWeek is 0-6
  - [ ] Validate dayOfMonth is 1-31
  - [ ] Validate monthOfYear is 1-12
  - [ ] Validate day is valid for selected month (e.g., no Feb 31)
  - [ ] Show clear validation error messages

- [ ] Handle edge cases
  - [ ] Day 31 for months with 30 days → use last day of month
  - [ ] February 29-31 → use last day of February (28 or 29)
  - [ ] Leap year handling for yearly recurrence
  - [ ] Default to current day of week/month if not specified

- [ ] Update RecurrenceSelector component
  - [ ] Add conditional fields based on frequency type
  - [ ] Show/hide appropriate inputs based on selection
  - [ ] Maintain state for all scheduling detail fields
  - [ ] Pass complete recurrence data to parent component

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: React client component
- Date Library: date-fns for date calculations
- Validation: Zod schema validation
- UI: Form inputs, selectors, dropdowns

**Integration Points:**
- RecurrenceSelector component (US-7.1)
- Bill creation form
- Date calculation utilities: `lib/utils/recurrence.ts`

**Date Calculation Functions:**

```typescript
// lib/utils/recurrence.ts
import { addDays, addWeeks, addMonths, addYears, isSameDay, lastDayOfMonth, setDate, setMonth } from 'date-fns';

export interface RecurrenceSettings {
  type: 'WEEKLY' | 'MONTHLY' | 'YEARLY';
  interval: number;
  dayOfWeek?: number;         // 0-6 (0=Sunday)
  dayOfMonth?: number;        // 1-31
  monthOfYear?: number;       // 1-12 (1=January)
  endDate?: string;
}

export function calculateNextRecurrenceDate(
  recurrence: RecurrenceSettings,
  lastDate: Date
): Date {
  const { type, interval, dayOfWeek, dayOfMonth, monthOfYear } = recurrence;

  switch (type) {
    case 'WEEKLY':
      // Add weeks and adjust to specific day of week
      let nextWeekly = addWeeks(lastDate, interval);
      if (dayOfWeek !== undefined) {
        // Adjust to the specified day of week
        const currentDay = nextWeekly.getDay();
        const daysToAdd = (dayOfWeek - currentDay + 7) % 7;
        nextWeekly = addDays(nextWeekly, daysToAdd);
      }
      return nextWeekly;

    case 'MONTHLY':
      // Add months and adjust to specific day of month
      let nextMonthly = addMonths(lastDate, interval);
      if (dayOfMonth !== undefined) {
        try {
          nextMonthly = setDate(nextMonthly, dayOfMonth);
        } catch {
          // Day doesn't exist in month (e.g., Feb 31) → use last day
          nextMonthly = lastDayOfMonth(nextMonthly);
        }
      }
      return nextMonthly;

    case 'YEARLY':
      // Add years and adjust to specific month and day
      let nextYearly = addYears(lastDate, interval);
      if (monthOfYear !== undefined) {
        nextYearly = setMonth(nextYearly, monthOfYear - 1); // setMonth uses 0-11
      }
      if (dayOfMonth !== undefined) {
        try {
          nextYearly = setDate(nextYearly, dayOfMonth);
        } catch {
          nextYearly = lastDayOfMonth(nextYearly);
        }
      }
      return nextYearly;

    default:
      throw new Error('Invalid recurrence type');
  }
}

export function shouldCreateToday(nextDate: Date): boolean {
  const today = new Date();
  return isSameDay(today, nextDate);
}

export function formatRecurrencePreview(
  recurrence: RecurrenceSettings,
  currentDate: Date
): string {
  const nextDate = calculateNextRecurrenceDate(recurrence, currentDate);
  const formatted = format(nextDate, 'EEEE, MMMM d, yyyy');

  return `Next bill will be created on: ${formatted}`;
}
```

**Component Structure:**

```typescript
// components/bills/RecurrenceSelector.tsx
'use client';

import { useState, useEffect } from 'react';
import { formatRecurrencePreview } from '@/lib/utils/recurrence';

export function RecurrenceSelector({ value, onChange }: Props) {
  const [frequency, setFrequency] = useState<'WEEKLY' | 'MONTHLY' | 'YEARLY'>('MONTHLY');
  const [interval, setInterval] = useState(1);
  const [dayOfWeek, setDayOfWeek] = useState<number | undefined>();
  const [dayOfMonth, setDayOfMonth] = useState<number | undefined>();
  const [monthOfYear, setMonthOfYear] = useState<number | undefined>();
  const [endDate, setEndDate] = useState<string | undefined>();

  // Update parent when values change
  useEffect(() => {
    const settings: RecurrenceSettings = {
      type: frequency,
      interval,
      dayOfWeek,
      dayOfMonth,
      monthOfYear,
      endDate
    };
    onChange(settings);
  }, [frequency, interval, dayOfWeek, dayOfMonth, monthOfYear, endDate]);

  // Preview calculation
  const preview = useMemo(() => {
    if (!value) return '';
    return formatRecurrencePreview(value, new Date());
  }, [value]);

  return (
    <div className="space-y-4">
      {/* Frequency Selector */}
      <select value={frequency} onChange={...}>
        <option value="WEEKLY">Weekly</option>
        <option value="MONTHLY">Monthly</option>
        <option value="YEARLY">Yearly</option>
      </select>

      {/* Interval */}
      <input type="number" min="1" value={interval} onChange={...} />

      {/* Conditional Fields */}
      {frequency === 'WEEKLY' && (
        <DayOfWeekSelector value={dayOfWeek} onChange={setDayOfWeek} />
      )}

      {frequency === 'MONTHLY' && (
        <input type="number" min="1" max="31" value={dayOfMonth} onChange={...} />
      )}

      {frequency === 'YEARLY' && (
        <>
          <MonthSelector value={monthOfYear} onChange={setMonthOfYear} />
          <input type="number" min="1" max="31" value={dayOfMonth} onChange={...} />
        </>
      )}

      {/* Preview */}
      <p className="text-sm text-gray-600">{preview}</p>
    </div>
  );
}
```

**Day of Week Selector:**

```typescript
const DAYS = [
  { value: 0, label: 'Sunday' },
  { value: 1, label: 'Monday' },
  { value: 2, label: 'Tuesday' },
  { value: 3, label: 'Wednesday' },
  { value: 4, label: 'Thursday' },
  { value: 5, label: 'Friday' },
  { value: 6, label: 'Saturday' }
];

function DayOfWeekSelector({ value, onChange }) {
  return (
    <select value={value} onChange={(e) => onChange(Number(e.target.value))}>
      {DAYS.map(day => (
        <option key={day.value} value={day.value}>{day.label}</option>
      ))}
    </select>
  );
}
```

**Month Selector:**

```typescript
const MONTHS = [
  { value: 1, label: 'January' },
  { value: 2, label: 'February' },
  // ... etc
  { value: 12, label: 'December' }
];

function MonthSelector({ value, onChange }) {
  return (
    <select value={value} onChange={(e) => onChange(Number(e.target.value))}>
      {MONTHS.map(month => (
        <option key={month.value} value={month.value}>{month.label}</option>
      ))}
    </select>
  );
}
```

**Edge Case Handling:**

- **Day 31 in February**: Use last day of February (28 or 29)
- **Day 31 in April/June/September/November**: Use day 30
- **Leap years**: date-fns handles automatically
- **Invalid combinations**: Validate before saving

**Validation Schema:**

```typescript
const RecurrenceDetailsSchema = z.object({
  type: z.enum(['WEEKLY', 'MONTHLY', 'YEARLY']),
  interval: z.number().int().min(1),
  dayOfWeek: z.number().int().min(0).max(6).optional(),
  dayOfMonth: z.number().int().min(1).max(31).optional(),
  monthOfYear: z.number().int().min(1).max(12).optional()
}).refine((data) => {
  // Custom validation: ensure appropriate fields are set
  if (data.type === 'WEEKLY' && data.dayOfWeek === undefined) return false;
  if (data.type === 'MONTHLY' && data.dayOfMonth === undefined) return false;
  if (data.type === 'YEARLY' && (data.monthOfYear === undefined || data.dayOfMonth === undefined)) return false;
  return true;
}, "Missing required scheduling details for selected frequency");
```

**Performance Considerations:**

- Memoize preview calculation to avoid unnecessary recalculations
- Debounce input changes if needed
- Date calculations are fast, no async needed

### Testing

**Test Location:**
- `__tests__/lib/utils/recurrence.test.ts`
- `__tests__/components/bills/RecurrenceSelector.test.tsx`

**Testing Standards:**
- Unit tests for date calculation functions
- Component tests for conditional rendering
- Integration tests for preview updates
- Edge case tests for date validation

**Testing Frameworks:**
- Vitest for unit tests
- React Testing Library for component tests
- date-fns testing utilities

**Specific Test Cases:**

**Date Calculation Tests:**
1. Weekly: calculates next Monday from Friday
2. Weekly with interval 2: skips one week
3. Monthly day 15: moves to 15th of next month
4. Monthly day 31 in February: uses Feb 28 (or 29 in leap year)
5. Yearly Jan 1: moves to next January 1st
6. Yearly Feb 29 in non-leap year: uses Feb 28
7. Edge case: day 31 in all months (April, June, September, November)

**Component Tests:**
8. Weekly selected: shows day of week selector
9. Monthly selected: shows day of month input
10. Yearly selected: shows month and day inputs
11. Preview updates when frequency changes
12. Preview updates when day/month changes
13. Validation error for missing dayOfWeek when Weekly
14. Validation error for invalid dayOfMonth (0, 32, etc.)
15. Day of week selector shows all 7 days
16. Month selector shows all 12 months

**Mock Data Example:**

```typescript
const mockWeeklyRecurrence = {
  type: 'WEEKLY' as const,
  interval: 1,
  dayOfWeek: 1 // Monday
};

const mockMonthlyRecurrence = {
  type: 'MONTHLY' as const,
  interval: 1,
  dayOfMonth: 15
};

const mockYearlyRecurrence = {
  type: 'YEARLY' as const,
  interval: 1,
  monthOfYear: 1, // January
  dayOfMonth: 1
};
```

**Edge Case Test Scenarios:**

```typescript
// Test Feb 31 → Feb 28/29
const febEdgeCase = {
  type: 'MONTHLY',
  interval: 1,
  dayOfMonth: 31
};
const baseDate = new Date(2025, 0, 31); // Jan 31, 2025
const next = calculateNextRecurrenceDate(febEdgeCase, baseDate);
// Expected: Feb 28, 2025 (not leap year)

// Test day 31 in April (30 days)
const aprilEdgeCase = {
  type: 'MONTHLY',
  interval: 1,
  dayOfMonth: 31
};
const marchDate = new Date(2025, 2, 31); // March 31, 2025
const aprilNext = calculateNextRecurrenceDate(aprilEdgeCase, marchDate);
// Expected: April 30, 2025
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created from Epic 7 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
