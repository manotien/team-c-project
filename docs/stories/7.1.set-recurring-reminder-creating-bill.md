# Story 7.1: Set Recurring Reminder When Creating Bill

**Epic:** [Epic 7: Recurring Reminders](epic-7-recurring-reminders.md)
**Story ID:** US-7.1
**Priority:** Medium (P2)
**Status:** Draft

---

## Story

**As a** user,
**I want** to choose a recurring reminder (weekly, monthly, yearly) when creating a bill,
**so that** the bill is automatically recreated on the specified schedule.

---

## Acceptance Criteria

1. "Set as Recurring" toggle/checkbox on Add Bill form
2. When enabled, shows recurrence options:
   - Frequency dropdown: Weekly / Monthly / Yearly
   - Interval input: "Every ___ weeks/months/years" (default: 1)
   - Optional end date: "End after date" (date picker)
3. Recurrence settings saved in `bill.recurrence` JSONB field
4. Recurrence settings format matches schema:
   ```json
   {
     "type": "MONTHLY",
     "interval": 1,
     "dayOfMonth": 15,
     "endDate": "2026-12-31"
   }
   ```
5. "Set as Recurring" toggle defaults to OFF (non-recurring by default)
6. Form validation: Ensure valid recurrence settings if enabled
7. Recurrence icon/badge shown on bill cards with recurrence

---

## Tasks / Subtasks

- [ ] Add recurrence toggle to bill form (AC: 1, 5)
  - [ ] Add "Set as Recurring" toggle/checkbox to bill capture form
  - [ ] Position toggle prominently in form (after basic bill details)
  - [ ] Default toggle to OFF state
  - [ ] Show/hide recurrence options based on toggle state

- [ ] Create RecurrenceSelector component (AC: 2)
  - [ ] Create `components/bills/RecurrenceSelector.tsx`
  - [ ] Implement frequency dropdown (Weekly/Monthly/Yearly)
  - [ ] Add interval number input with validation (min: 1)
  - [ ] Add optional end date picker
  - [ ] Apply conditional rendering based on toggle state

- [ ] Implement recurrence data storage (AC: 3, 4)
  - [ ] Update bill creation API to accept recurrence data
  - [ ] Store recurrence settings in `bill.recurrence` JSONB column
  - [ ] Validate recurrence data structure against schema
  - [ ] Ensure proper JSON serialization/deserialization

- [ ] Add form validation (AC: 6)
  - [ ] Validate frequency selection is not empty
  - [ ] Validate interval is positive integer
  - [ ] Validate end date is in the future (if provided)
  - [ ] Validate end date is after due date (if provided)
  - [ ] Show validation errors clearly

- [ ] Display recurrence indicator on bill cards (AC: 7)
  - [ ] Add recurrence icon/badge to bill card component
  - [ ] Show icon only for bills with recurrence settings
  - [ ] Use appropriate icon (🔁, ↻, or similar)
  - [ ] Add tooltip or label: "Recurring bill"

- [ ] Update database schema if needed
  - [ ] Ensure `bill.recurrence` JSONB column exists
  - [ ] Create migration if column doesn't exist
  - [ ] Add index on recurrence field for performance (optional)

- [ ] Handle edge cases and testing
  - [ ] Test toggle on/off behavior
  - [ ] Test form submission with and without recurrence
  - [ ] Test validation errors display correctly
  - [ ] Test recurrence data persists correctly
  - [ ] Test bill cards show recurrence indicator

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: React client component for interactive form
- Database: Prisma ORM with JSONB support
- UI: Form components (shadcn/ui or custom)
- Validation: Zod schema validation

**Integration Points:**
- Bill capture form (Epic 1): `components/bill-capture/bill-capture.tsx`
- Bill creation API: `app/api/bills/route.ts`
- Bill card component: `components/TaskCard.tsx` or bill card component
- Database schema: `prisma/schema.prisma`

**Recurrence Data Schema:**

```typescript
interface RecurrenceSettings {
  type: 'WEEKLY' | 'MONTHLY' | 'YEARLY';
  interval: number;           // Every N weeks/months/years
  dayOfWeek?: number;         // 0-6 for weekly (0=Sunday)
  dayOfMonth?: number;        // 1-31 for monthly/yearly
  monthOfYear?: number;       // 1-12 for yearly (1=January)
  endDate?: string;           // ISO date string, optional
}
```

**Component Structure:**

```typescript
// components/bills/RecurrenceSelector.tsx
'use client';

import { useState } from 'react';

interface RecurrenceSelectorProps {
  value: RecurrenceSettings | null;
  onChange: (value: RecurrenceSettings | null) => void;
}

export function RecurrenceSelector({ value, onChange }: RecurrenceSelectorProps) {
  const [enabled, setEnabled] = useState(!!value);

  // Implementation details...
}
```

**Form Integration:**

- Add toggle switch before form submit button
- Conditionally render RecurrenceSelector when toggle is ON
- Include recurrence data in form submission payload
- Update bill creation API to handle recurrence field

**Database Schema (Prisma):**

```prisma
model Bill {
  id          String   @id @default(uuid())
  // ... other fields ...
  recurrence  Json?    // JSONB field for recurrence settings
}
```

**API Update:**

```typescript
// app/api/bills/route.ts
export async function POST(req: Request) {
  const body = await req.json();
  const { recurrence, ...billData } = body;

  const bill = await prisma.bill.create({
    data: {
      ...billData,
      recurrence: recurrence || null
    }
  });

  return NextResponse.json(bill);
}
```

**Validation Schema (Zod):**

```typescript
const RecurrenceSchema = z.object({
  type: z.enum(['WEEKLY', 'MONTHLY', 'YEARLY']),
  interval: z.number().int().min(1),
  dayOfWeek: z.number().int().min(0).max(6).optional(),
  dayOfMonth: z.number().int().min(1).max(31).optional(),
  monthOfYear: z.number().int().min(1).max(12).optional(),
  endDate: z.string().datetime().optional()
});
```

**Key Implementation Details:**

- Use controlled components for all form inputs
- Store recurrence settings in component state
- Pass recurrence data to parent form component
- Clear recurrence data when toggle is turned OFF
- Preserve recurrence data when toggling ON again (optional UX improvement)

**Styling Guidelines:**

- Toggle switch should be visually prominent
- Recurrence options should be clearly grouped/indented
- Use consistent spacing and layout
- Disable recurrence inputs when toggle is OFF (visual feedback)
- End date picker should follow app's date picker pattern

**Performance Considerations:**

- JSONB field is efficient for flexible schema
- No additional database joins needed
- Consider indexing recurrence field if querying frequently
- Validate on client-side before API call to reduce errors

### Testing

**Test Location:**
- `__tests__/components/bills/RecurrenceSelector.test.tsx`
- `__tests__/app/api/bills/route.test.ts`

**Testing Standards:**
- Unit tests for RecurrenceSelector component
- Integration tests for bill creation with recurrence
- Form validation tests
- Database persistence tests

**Testing Frameworks:**
- Vitest for unit tests
- React Testing Library for component tests
- Mock Prisma client for database tests

**Specific Test Cases:**

1. Toggle defaults to OFF on form load
2. Recurrence options hidden when toggle is OFF
3. Recurrence options shown when toggle is ON
4. Frequency dropdown shows all options (Weekly/Monthly/Yearly)
5. Interval input accepts positive integers only
6. Interval input rejects negative numbers and zero
7. End date picker allows future dates only
8. Form validation shows errors for invalid recurrence settings
9. Recurrence data structure matches schema when submitted
10. Bill created with recurrence data saves correctly to database
11. Bill created without recurrence saves null to recurrence field
12. Bill cards show recurrence icon for recurring bills
13. Bill cards hide recurrence icon for non-recurring bills
14. Toggle OFF clears recurrence data from form state

**Mock Data Example:**

```typescript
const mockRecurrenceMonthly = {
  type: 'MONTHLY' as const,
  interval: 1,
  dayOfMonth: 15,
  endDate: '2026-12-31T00:00:00Z'
};

const mockRecurrenceWeekly = {
  type: 'WEEKLY' as const,
  interval: 2,
  dayOfWeek: 1, // Monday
  endDate: null
};
```

**Integration Test Scenario:**

1. User opens bill creation form
2. Fills in basic bill details (vendor, amount, due date)
3. Toggles "Set as Recurring" to ON
4. Selects "Monthly" frequency
5. Sets interval to 1 (every month)
6. Saves bill
7. Verify recurrence data saved to database
8. Verify bill card shows recurrence icon

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created from Epic 7 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
