# User Story 7.1: Set Recurring Reminder When Creating Bill

**Story ID:** US-7.1
**Epic:** [EPIC-7: Recurring Reminders](epic-7-recurring-reminders.md)
**Priority:** Medium (P2)
**Status:** Ready for Development

---

## User Story

**As a** user
**I want to** choose a recurring reminder (weekly, monthly, yearly) when creating a bill
**So that** the bill is automatically recreated on the specified schedule

---

## Story Context

**Existing System Integration:**
- Integrates with: Add Bill form (Epic 1)
- Technology: Next.js, Prisma, React client components
- Follows pattern: Form components with conditional fields
- Touch points: Bill model (`recurrence` JSONB field), Add Bill form UI

---

## Acceptance Criteria

**Functional Requirements:**

1. "Set as Recurring" toggle/checkbox on Add Bill form
2. When enabled, shows recurrence options:
   - Frequency dropdown: Weekly / Monthly / Yearly
   - Interval input: "Every ___ weeks/months/years" (default: 1)
   - Optional end date: "End after date" (date picker)
3. Recurrence settings saved in `bill.recurrence` JSONB field
4. Recurrence settings format:
   ```json
   {
     "type": "MONTHLY",
     "interval": 1,
     "dayOfMonth": 15,
     "endDate": "2026-12-31"
   }
   ```
5. "Set as Recurring" toggle defaults to OFF (non-recurring by default)
6. Form validation: Ensure valid recurrence settings if enabled
7. Recurrence icon/badge shown on bill cards with recurrence

**Integration Requirements:**

8. Existing Add Bill form functionality continues to work unchanged
9. New functionality follows existing form component pattern
10. Integration with bill creation maintains current behavior

**Quality Requirements:**

11. Change is covered by appropriate tests
12. Documentation is updated if needed
13. No regression in existing functionality verified

---

## Technical Notes

**Recurrence Data Schema:**
```typescript
interface RecurrenceSettings {
  type: 'WEEKLY' | 'MONTHLY' | 'YEARLY';
  interval: number;           // Every N weeks/months/years
  dayOfWeek?: number;         // 0-6 for weekly (0=Sunday)
  dayOfMonth?: number;        // 1-31 for monthly/yearly
  monthOfYear?: number;       // 1-12 for yearly (1=January)
  endDate?: Date;             // Optional stop date
}
```

- **Integration Approach:** Extend existing Add Bill form with conditional recurrence fields
- **Component Location:** `components/bills/RecurrenceSelector.tsx`
- **Database Field:** Store in `bill.recurrence` JSONB column (additive schema change)
- **Existing Pattern Reference:** Follow form component patterns in `components/bills/`
- **Key Constraints:**
  - Don't create future bills immediately (use Bull queue worker)
  - Toggle defaults to OFF to maintain current non-recurring behavior
  - JSONB allows flexible schema evolution

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Form complexity increases, potential UX confusion
- **Mitigation:** Progressive disclosure (hide recurrence fields until toggle enabled), clear preview text
- **Rollback:** Remove toggle and recurrence fields from form, nullify recurrence column

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Database changes are additive only (new JSONB column, nullable)
- [x] UI changes follow existing design patterns (form fields)
- [x] Performance impact is negligible (client-side form state)

---

## Definition of Done

- [ ] Functional requirements met (AC 1-7)
- [ ] Integration requirements verified (AC 8-10)
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] "Set as Recurring" toggle functional
- [ ] Frequency dropdown works (Weekly/Monthly/Yearly)
- [ ] Interval input validates correctly
- [ ] End date picker functional
- [ ] Recurrence settings saved to database correctly
- [ ] Recurrence icon/badge displays on bill cards
- [ ] Form validation prevents invalid settings
- [ ] Documentation updated if applicable

---

## Dependencies

**Upstream Dependencies:**
- Epic 1 (Bill Capture): Add Bill form extended with recurrence settings

**Downstream Dependencies:**
- US-7.2: Provides UI foundation for scheduling details

---

## Notes

- **UI Framework:** Use shadcn/ui form components (Select, DatePicker, Switch/Checkbox)
- **Form Library:** Use React Hook Form for form state management
- **Validation:** Use Zod schema for recurrence settings validation
- **Database Migration:** Add nullable `recurrence` JSONB column to `bill` table
- **Future Enhancements:**
  - Edit recurrence settings on existing bills
  - Pause/resume recurrence
  - Recurrence templates (common patterns)
