# Story 0.3: Configure Prisma and Database Schema

**Epic:** Epic 0 - Project Initialization & Setup
**Story ID:** US-0.3
**Priority:** Critical (P0)
**Estimate:** 2 hours

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to set up Prisma ORM with the complete database schema,
**so that** I can perform type-safe database operations.

---

## Acceptance Criteria

1. Prisma initialized with `pnpm prisma init`
2. `prisma/schema.prisma` created with all data models (User, Bill, Task, Notification)
3. All enums defined (BillType, TaskStatus, NotificationType, NotificationStatus)
4. All relationships configured correctly (1:1, 1:N)
5. All indexes defined for performance
6. Cascade delete relationships configured
7. Database URL configured in `.env.local`
8. Prisma Client generated successfully (`pnpm prisma generate`)
9. Database schema pushed to PostgreSQL (`pnpm prisma db push`)
10. Prisma Client singleton created at `lib/prisma.ts`
11. No Prisma warnings or errors in console

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize Prisma** (AC: 1, 7)
  - [ ] Run `pnpm prisma init`
  - [ ] Verify `prisma/schema.prisma` created
  - [ ] Verify `.env` created with DATABASE_URL placeholder
  - [ ] Update `.env.local` with: `DATABASE_URL="postgresql://postgres:postgres@localhost:5432/household_bills"`
  - [ ] Add `.env` to .gitignore if not already there

- [ ] **Task 2: Define User model** (AC: 2)
  - [ ] Add User model with fields: id (UUID), lineUserId (String unique), name, avatarUrl (nullable), createdAt, updatedAt
  - [ ] Add @@map("users") for table name
  - [ ] Add @@index on lineUserId
  - [ ] Add relationships: bills[], tasks[], notifications[]

- [ ] **Task 3: Define Bill model** (AC: 2, 4)
  - [ ] Add Bill model with fields: id, userId, vendor, amount (Decimal), currency, dueDate, billType (enum), rawImageUrl, ocrData (Json), recurrence (Json nullable), createdAt, updatedAt
  - [ ] Add @@map("bills") for table name
  - [ ] Add @db.Decimal(10, 2) annotation for amount
  - [ ] Add relationship to User (fields: [userId], references: [id], onDelete: Cascade)
  - [ ] Add relationship to Task (1:1 optional)
  - [ ] Add indexes: userId, dueDate

- [ ] **Task 4: Define Task model** (AC: 2, 4, 6)
  - [ ] Add Task model with fields: id, billId (unique), userId, title, status (enum), dueDate, paidAt (nullable), paymentProofUrl (nullable), createdAt, updatedAt
  - [ ] Add @@map("tasks") for table name
  - [ ] Add relationship to Bill (fields: [billId], references: [id], onDelete: Cascade)
  - [ ] Add relationship to User (fields: [userId], references: [id], onDelete: Cascade)
  - [ ] Add relationship to Notification[]
  - [ ] Add indexes: userId, status, dueDate, (userId + status), (status + dueDate)

- [ ] **Task 5: Define Notification model** (AC: 2, 4, 6)
  - [ ] Add Notification model with fields: id, userId, taskId, type (enum), status (enum), message, sentAt (nullable), readAt (nullable), metadata (Json), createdAt
  - [ ] Add @@map("notifications") for table name
  - [ ] Add relationship to User (fields: [userId], references: [id], onDelete: Cascade)
  - [ ] Add relationship to Task (fields: [taskId], references: [id], onDelete: Cascade)
  - [ ] Add indexes: userId, taskId, status

- [ ] **Task 6: Define all enums** (AC: 3)
  - [ ] Add BillType enum: ELECTRIC, WATER, INTERNET, CAR, HOME, OTHER
  - [ ] Add TaskStatus enum: UNPAID, PAID
  - [ ] Add NotificationType enum: BILL_CREATED, DUE_SOON, DUE_TODAY
  - [ ] Add NotificationStatus enum: PENDING, SENT, FAILED, READ

- [ ] **Task 7: Configure Prisma generator and datasource**
  - [ ] Verify generator client: `provider = "prisma-client-js"`
  - [ ] Verify datasource db: `provider = "postgresql"`, `url = env("DATABASE_URL")`

- [ ] **Task 8: Generate Prisma Client** (AC: 8)
  - [ ] Run `pnpm prisma generate`
  - [ ] Verify `.prisma/client` directory created
  - [ ] Verify no errors in output
  - [ ] Verify types generated in node_modules

- [ ] **Task 9: Push schema to database** (AC: 9)
  - [ ] Run `pnpm prisma db push`
  - [ ] Verify all tables created in PostgreSQL
  - [ ] Check with Prisma Studio: `pnpm prisma studio`
  - [ ] Verify schema matches expectations (tables, columns, indexes)

- [ ] **Task 10: Create Prisma Client singleton** (AC: 10)
  - [ ] Create `lib/prisma.ts` file
  - [ ] Export singleton PrismaClient instance
  - [ ] Add globalThis caching for development (prevent hot-reload connections)
  - [ ] Handle production vs development environment

- [ ] **Task 11: Verify setup** (AC: 11)
  - [ ] Run `pnpm prisma validate` - should pass
  - [ ] Run `pnpm prisma studio` - should open GUI
  - [ ] Verify no warnings in console
  - [ ] Test creating a record through Prisma Studio

---

## Dev Notes

### Complete Prisma Schema (from docs/architecture.md)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  lineUserId  String   @unique @map("line_user_id")
  name        String
  avatarUrl   String?  @map("avatar_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  bills         Bill[]
  tasks         Task[]
  notifications Notification[]

  @@map("users")
}

model Bill {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  vendor      String
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("THB")
  dueDate     DateTime @map("due_date")
  billType    BillType @map("bill_type")
  rawImageUrl String   @map("raw_image_url")
  ocrData     Json     @default("{}") @map("ocr_data")
  recurrence  Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task?

  @@index([userId])
  @@index([dueDate])
  @@map("bills")
}

model Task {
  id              String     @id @default(uuid())
  billId          String     @unique @map("bill_id")
  userId          String     @map("user_id")
  title           String
  status          TaskStatus @default(UNPAID)
  dueDate         DateTime   @map("due_date")
  paidAt          DateTime?  @map("paid_at")
  paymentProofUrl String?    @map("payment_proof_url")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relationships
  bill          Bill           @relation(fields: [billId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([userId, status])
  @@index([status, dueDate])
  @@map("tasks")
}

model Notification {
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  taskId    String             @map("task_id")
  type      NotificationType
  status    NotificationStatus @default(PENDING)
  message   String
  sentAt    DateTime?          @map("sent_at")
  readAt    DateTime?          @map("read_at")
  metadata  Json               @default("{}")
  createdAt DateTime           @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskId])
  @@index([status])
  @@map("notifications")
}

// Enums
enum BillType {
  ELECTRIC
  WATER
  INTERNET
  CAR
  HOME
  OTHER
}

enum TaskStatus {
  UNPAID
  PAID
}

enum NotificationType {
  BILL_CREATED
  DUE_SOON
  DUE_TODAY
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}
```

### Prisma Client Singleton (lib/prisma.ts)

```typescript
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  });

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### Key Schema Design Decisions

**Single-User Architecture:**
- Each user manages their own bills/tasks independently
- No group or member assignment concepts
- Task.userId is the owner (no separate assignee)

**Relationships:**
- User → Bills (1:N)
- User → Tasks (1:N)
- Bill → Task (1:1, task auto-created with bill)
- Task → Notifications (1:N)

**Cascade Deletes:**
- Delete user → Delete all bills, tasks, notifications
- Delete bill → Delete related task
- Delete task → Delete related notifications

**Indexes for Performance:**
- User: lineUserId (unique lookups)
- Bill: userId, dueDate (filtering)
- Task: userId, status, dueDate, composite indexes for dashboard queries
- Notification: userId, taskId, status (filtering)

### Testing

**Verification Commands:**
- `pnpm prisma validate` - Check schema syntax
- `pnpm prisma format` - Format schema file
- `pnpm prisma generate` - Generate client
- `pnpm prisma db push` - Push to database
- `pnpm prisma studio` - Visual database editor

**Manual Testing in Prisma Studio:**
1. Create test user record
2. Create test bill record linked to user
3. Create test task record linked to bill
4. Verify relationships work
5. Delete records to test cascade behavior

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
