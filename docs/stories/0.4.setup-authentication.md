# Story 0.4: Setup Authentication (NextAuth + LINE)

**Epic:** Epic 0 - Project Initialization & Setup
**Story ID:** US-0.4
**Priority:** Critical (P0)
**Estimate:** 3 hours

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to configure NextAuth.js with LINE OAuth provider,
**so that** users can authenticate with LINE.

---

## Acceptance Criteria

1. NextAuth.js installed and configured
2. LINE Login channel created in LINE Developers Console
3. LINE LIFF app registered
4. Environment variables configured for LINE OAuth (CLIENT_ID, CLIENT_SECRET, LIFF_ID)
5. NEXTAUTH_SECRET generated and configured
6. Auth config created at `lib/auth.ts` with LINE provider
7. API route created at `app/api/auth/[...nextauth]/route.ts`
8. Middleware configured for protected routes at `middleware.ts`
9. Session callback updates user data in database
10. Test login flow works end-to-end (sandbox mode)

---

## Tasks / Subtasks

- [ ] **Task 1: Install NextAuth.js** (AC: 1)
  - [ ] Run `pnpm add next-auth`
  - [ ] Verify version 5.0+ installed
  - [ ] Check package.json for next-auth dependency

- [ ] **Task 2: Create LINE Login channel** (AC: 2)
  - [ ] Go to LINE Developers Console: https://developers.line.biz/console/
  - [ ] Create new provider (if needed)
  - [ ] Create LINE Login channel
  - [ ] Note Channel ID (LINE_CLIENT_ID)
  - [ ] Note Channel Secret (LINE_CLIENT_SECRET)
  - [ ] Configure Callback URL: `http://localhost:3000/api/auth/callback/line`
  - [ ] Enable scopes: `openid`, `profile`

- [ ] **Task 3: Create LINE LIFF app** (AC: 3)
  - [ ] In LINE Developers Console, go to LIFF tab
  - [ ] Create new LIFF app
  - [ ] Set Endpoint URL: `http://localhost:3000`
  - [ ] Set LIFF app size: Full
  - [ ] Note LIFF ID (NEXT_PUBLIC_LINE_LIFF_ID)
  - [ ] Link LIFF app to LINE Login channel

- [ ] **Task 4: Generate NextAuth secret** (AC: 5)
  - [ ] Run `openssl rand -base64 32`
  - [ ] Copy output for NEXTAUTH_SECRET
  - [ ] Save securely for .env.local configuration

- [ ] **Task 5: Configure environment variables** (AC: 4, 5)
  - [ ] Add to `.env.local`:
    - [ ] `NEXTAUTH_URL="http://localhost:3000"`
    - [ ] `NEXTAUTH_SECRET="<generated-secret>"`
    - [ ] `LINE_CLIENT_ID="<from-line-console>"`
    - [ ] `LINE_CLIENT_SECRET="<from-line-console>"`
    - [ ] `NEXT_PUBLIC_LINE_LIFF_ID="<liff-id>"`

- [ ] **Task 6: Create auth configuration** (AC: 6, 9)
  - [ ] Create `lib/auth.ts`
  - [ ] Import NextAuth and LINE provider
  - [ ] Configure LINE provider with client ID and secret
  - [ ] Add signIn callback to create/update user in database
  - [ ] Add session callback to add user ID to session
  - [ ] Export authOptions

- [ ] **Task 7: Create NextAuth API route** (AC: 7)
  - [ ] Update `app/api/auth/[...nextauth]/route.ts`
  - [ ] Import authOptions from lib/auth
  - [ ] Export GET and POST handlers from NextAuth
  - [ ] Verify route handles all NextAuth endpoints

- [ ] **Task 8: Create middleware for protected routes** (AC: 8)
  - [ ] Create `middleware.ts` in project root
  - [ ] Import middleware from next-auth
  - [ ] Configure matcher for protected routes: `/dashboard/*`, `/tasks/*`, `/bills/*`
  - [ ] Export middleware and config

- [ ] **Task 9: Test authentication flow** (AC: 10)
  - [ ] Start dev server: `pnpm dev`
  - [ ] Navigate to `/api/auth/signin`
  - [ ] Click "Sign in with LINE"
  - [ ] Verify redirect to LINE OAuth consent
  - [ ] Grant permissions in LINE sandbox
  - [ ] Verify redirect back to app
  - [ ] Check user created in database (Prisma Studio)
  - [ ] Verify session exists (check cookies)
  - [ ] Test protected route access

---

## Dev Notes

### NextAuth Configuration (lib/auth.ts)

```typescript
import NextAuth, { NextAuthOptions } from 'next-auth';
import LineProvider from 'next-auth/providers/line';
import { PrismaAdapter } from '@next-auth/prisma-adapter';
import { prisma } from './prisma';

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),
  providers: [
    LineProvider({
      clientId: process.env.LINE_CLIENT_ID!,
      clientSecret: process.env.LINE_CLIENT_SECRET!,
    }),
  ],
  callbacks: {
    async signIn({ user, account, profile }) {
      if (account?.provider === 'line' && profile) {
        // Create or update user in database
        const existingUser = await prisma.user.findUnique({
          where: { lineUserId: profile.sub },
        });

        if (!existingUser) {
          await prisma.user.create({
            data: {
              lineUserId: profile.sub,
              name: profile.name || 'LINE User',
              avatarUrl: profile.picture,
            },
          });
        } else {
          // Update user profile data on each login
          await prisma.user.update({
            where: { lineUserId: profile.sub },
            data: {
              name: profile.name || existingUser.name,
              avatarUrl: profile.picture || existingUser.avatarUrl,
            },
          });
        }
      }
      return true;
    },
    async session({ session, token }) {
      // Add user ID to session
      if (token.sub) {
        const user = await prisma.user.findUnique({
          where: { lineUserId: token.sub },
        });
        if (user) {
          session.user.id = user.id;
        }
      }
      return session;
    },
  },
  pages: {
    signIn: '/login',
  },
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };
```

### NextAuth API Route (app/api/auth/[...nextauth]/route.ts)

```typescript
import { authOptions } from '@/lib/auth';
import NextAuth from 'next-auth';

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

### Middleware Configuration (middleware.ts)

```typescript
export { default } from 'next-auth/middleware';

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/tasks/:path*',
    '/bills/:path*',
  ],
};
```

### LINE Developer Console Setup Checklist

**Prerequisites:**
- [ ] LINE account (personal or business)
- [ ] LINE Developers Console access

**Channel Setup:**
1. [ ] Create Provider (if first time)
2. [ ] Create LINE Login channel
3. [ ] Note Channel ID and Secret
4. [ ] Add Callback URL: `http://localhost:3000/api/auth/callback/line`
5. [ ] Enable `openid` and `profile` scopes
6. [ ] Add developer LINE accounts for testing

**LIFF App Setup:**
1. [ ] Create LIFF app in channel
2. [ ] Set Endpoint URL: `http://localhost:3000`
3. [ ] Set size: Full
4. [ ] Note LIFF ID
5. [ ] Link to LINE Login channel

**Testing:**
- [ ] Use LINE sandbox mode for development
- [ ] Add test LINE accounts as channel testers
- [ ] Verify OAuth flow in browser
- [ ] Check user data syncs to database

### Environment Variables Required

```bash
# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="<run: openssl rand -base64 32>"

# LINE LIFF & Login
NEXT_PUBLIC_LINE_LIFF_ID="<from LINE Developers Console>"
LINE_CLIENT_ID="<from LINE Developers Console>"
LINE_CLIENT_SECRET="<from LINE Developers Console>"
```

### Important Notes

**LINE OAuth Flow:**
1. User clicks "Login with LINE"
2. Redirect to LINE OAuth consent page
3. User grants permissions
4. LINE redirects to callback URL with code
5. NextAuth exchanges code for access token
6. NextAuth fetches user profile
7. SignIn callback creates/updates user in database
8. Session created with user data

**Session Management:**
- Sessions stored in httpOnly cookies (secure)
- 30-day rolling session duration
- Session refreshes on page load if < 24 hours remaining

**Security:**
- CSRF protection built into NextAuth
- State parameter for OAuth flow validation
- Secure cookie flags in production
- No password storage (OAuth only)

### Testing

**Manual Testing Steps:**
1. Start dev server: `pnpm dev`
2. Open browser: `http://localhost:3000/api/auth/signin`
3. Click "Sign in with LINE"
4. Complete LINE OAuth consent
5. Verify redirect back to app
6. Open Prisma Studio: `pnpm prisma studio`
7. Check users table for new record
8. Verify lineUserId, name, avatarUrl populated
9. Check browser cookies for next-auth.session-token
10. Navigate to protected route (e.g., /dashboard)
11. Verify access granted (not redirected to login)
12. Test logout: `/api/auth/signout`

**No automated tests for this story** - Manual OAuth flow verification only

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
