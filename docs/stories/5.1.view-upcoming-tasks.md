# Story 5.1: View Upcoming Tasks

**Epic:** EPIC-5 - Dashboard & Tracking
**Story ID:** US-5.1
**Priority:** Critical (P0)
**Status:** Draft

---

## Story

**As a** user,
**I want** to see upcoming tasks so I don't miss deadlines,
**so that** I can plan my payments in advance

---

## Acceptance Criteria

1. Dashboard displays "Upcoming Tasks" section
2. Shows tasks with status = UNPAID
3. Sorted by due date (earliest first)
4. Tasks due within next 7 days highlighted as "Due Soon"
5. Each task card shows:
   - Vendor name
   - Amount (฿1,500.00)
   - Due date (relative: "in 2 days" or absolute: "Oct 15")
   - Bill type icon (⚡💧🌐🚗🏠)
   - "Due Soon" badge if within 7 days
6. Click task card navigates to task detail page
7. Empty state: "No upcoming bills" (if all paid or no tasks)
8. Shows up to 10 tasks by default (paginate if more)

---

## Tasks / Subtasks

- [ ] Create UpcomingTasks component (AC: 1, 2, 3)
  - [ ] Create `components/dashboard/UpcomingTasks.tsx`
  - [ ] Fetch tasks with Prisma query (status: UNPAID)
  - [ ] Sort by dueDate ascending
  - [ ] Limit to 10 tasks initially
  - [ ] Use React Server Component for data fetching

- [ ] Implement "Due Soon" logic (AC: 4)
  - [ ] Calculate if task is due within 7 days
  - [ ] Add `isDueSoon` helper function
  - [ ] Apply "Due Soon" badge conditionally
  - [ ] Use date-fns or dayjs for date calculations

- [ ] Create TaskCard component (AC: 5)
  - [ ] Create `components/tasks/TaskCard.tsx`
  - [ ] Display vendor name
  - [ ] Display amount with THB formatting (฿1,500.00)
  - [ ] Display relative due date ("in 2 days")
  - [ ] Display bill type icon (Epic 8 integration)
  - [ ] Show "Due Soon" badge if applicable
  - [ ] Apply consistent styling and layout

- [ ] Add navigation on click (AC: 6)
  - [ ] Wrap TaskCard in Link or make clickable
  - [ ] Navigate to `/tasks/[taskId]` on click
  - [ ] Add hover state for better UX
  - [ ] Ensure entire card is clickable

- [ ] Implement empty state (AC: 7)
  - [ ] Check if tasks array is empty
  - [ ] Display "No upcoming bills" message
  - [ ] Add friendly illustration or icon
  - [ ] Provide CTA: "Add your first bill"

- [ ] Add pagination (AC: 8)
  - [ ] Show "View All" or "Load More" button if >10 tasks
  - [ ] Implement pagination with page numbers or infinite scroll
  - [ ] Update Prisma query with skip/take parameters
  - [ ] Handle loading state during pagination

- [ ] Format dates and currency (AC: 5c, 5b)
  - [ ] Use date-fns for relative time formatting
  - [ ] Format currency with Intl.NumberFormat or custom helper
  - [ ] Display absolute date as fallback ("Oct 15, 2025")
  - [ ] Ensure timezone consistency

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: Next.js React Server Components
- Database: Prisma ORM
- Date utilities: date-fns
- UI: shadcn/ui Badge, Card components
- Styling: Tailwind CSS

**Integration Points:**
- Epic 2 (Task Creation): Tasks must exist to display
- Epic 4 (Task Actions): Task status updates reflected
- Epic 8 (US-8.2): Bill type icons integration
- Dashboard page: `app/(dashboard)/dashboard/page.tsx`

**Key Implementation Details:**

**Prisma Query:**
```typescript
const upcomingTasks = await prisma.task.findMany({
  where: {
    userId: session.user.id,
    status: 'UNPAID'
  },
  include: {
    bill: true // Include bill details for vendor, amount, type
  },
  orderBy: {
    dueDate: 'asc'
  },
  take: 10
});
```

**"Due Soon" Helper Function:**
```typescript
import { addDays, isBefore } from 'date-fns';

export function isDueSoon(dueDate: Date): boolean {
  const now = new Date();
  const sevenDaysFromNow = addDays(now, 7);
  return isBefore(dueDate, sevenDaysFromNow);
}
```

**UpcomingTasks Component (`components/dashboard/UpcomingTasks.tsx`):**
```typescript
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { TaskCard } from '@/components/tasks/TaskCard';

export async function UpcomingTasks() {
  const session = await getServerSession(authOptions);

  if (!session) {
    return null;
  }

  const upcomingTasks = await prisma.task.findMany({
    where: {
      userId: session.user.id,
      status: 'UNPAID'
    },
    include: {
      bill: true
    },
    orderBy: {
      dueDate: 'asc'
    },
    take: 10
  });

  if (upcomingTasks.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-muted-foreground">No upcoming bills</p>
        <a href="/bills/new" className="text-primary underline mt-2">
          Add your first bill
        </a>
      </div>
    );
  }

  return (
    <section>
      <h2 className="text-2xl font-bold mb-4">Upcoming Tasks</h2>
      <div className="space-y-3">
        {upcomingTasks.map(task => (
          <TaskCard key={task.id} task={task} />
        ))}
      </div>
      {upcomingTasks.length === 10 && (
        <a href="/tasks" className="text-primary underline mt-4 block">
          View all tasks
        </a>
      )}
    </section>
  );
}
```

**TaskCard Component (`components/tasks/TaskCard.tsx`):**
```typescript
'use client';

import Link from 'next/link';
import { formatDistanceToNow, format } from 'date-fns';
import { Badge } from '@/components/ui/badge';
import { BillTypeIcon } from '@/components/bills/BillTypeIcon';
import { isDueSoon } from '@/lib/utils/dateHelpers';
import type { Task, Bill } from '@prisma/client';

interface TaskCardProps {
  task: Task & { bill: Bill };
}

export function TaskCard({ task }: TaskCardProps) {
  const dueSoon = isDueSoon(task.dueDate);
  const relativeDate = formatDistanceToNow(task.dueDate, { addSuffix: true });
  const absoluteDate = format(task.dueDate, 'MMM dd');

  return (
    <Link href={`/tasks/${task.id}`}>
      <div className="border rounded-lg p-4 hover:bg-accent transition-colors cursor-pointer">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <BillTypeIcon type={task.bill.billType} size="md" />
            <div>
              <h3 className="font-semibold">
                {task.bill.vendor || 'Bill Payment'}
              </h3>
              <p className="text-sm text-muted-foreground">
                Due {relativeDate} ({absoluteDate})
              </p>
            </div>
          </div>
          <div className="text-right">
            <p className="font-bold text-lg">
              ฿{task.bill.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
            </p>
            {dueSoon && (
              <Badge variant="warning" className="mt-1">
                Due Soon
              </Badge>
            )}
          </div>
        </div>
      </div>
    </Link>
  );
}
```

**Date Formatting Helpers (`lib/utils/dateHelpers.ts`):**
```typescript
import { addDays, isBefore, formatDistanceToNow, format } from 'date-fns';

export function isDueSoon(dueDate: Date): boolean {
  const now = new Date();
  const sevenDaysFromNow = addDays(now, 7);
  return isBefore(dueDate, sevenDaysFromNow) && !isOverdue(dueDate);
}

export function isOverdue(dueDate: Date): boolean {
  return isBefore(dueDate, new Date());
}

export function formatRelativeDate(date: Date): string {
  return formatDistanceToNow(date, { addSuffix: true });
}

export function formatAbsoluteDate(date: Date): string {
  return format(date, 'MMM dd, yyyy');
}
```

**Currency Formatting:**
```typescript
export function formatCurrency(amount: number, currency = 'THB'): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: 2
  }).format(amount);
}

// Or simple Thai Baht formatting:
export function formatTHB(amount: number): string {
  return `฿${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
}
```

**Database Indexes for Performance:**
```sql
-- Composite index for optimal query performance
CREATE INDEX idx_tasks_user_status_duedate
ON tasks(user_id, status, due_date);
```

**Performance Considerations:**
- Use React Server Components for data fetching (no client JS needed)
- Database query optimized with include for bill details
- Limit to 10 tasks to reduce initial load time
- Consider caching with Next.js revalidate

### Dependencies

**Upstream Dependencies:**
- Epic 2 (Task Creation): Tasks must exist in database
- Epic 9 (Authentication): User session required

**Downstream Dependencies:**
- Epic 8 (US-8.2): Bill type icons in task cards
- Epic 5 (US-5.2): Overdue tasks will be integrated with this view

### Testing

**Test Location:** `__tests__/components/dashboard/UpcomingTasks.test.tsx` and `__tests__/components/tasks/TaskCard.test.tsx`

**Testing Standards:**
- Unit tests for date helper functions
- Unit tests for TaskCard component
- Integration tests for UpcomingTasks data fetching
- E2E test for dashboard display
- Test empty states
- Test pagination

**Testing Frameworks:**
- Jest for unit tests
- React Testing Library for component tests
- Playwright for E2E tests
- Mock Prisma client for database queries

**Specific Requirements:**
- Test isDueSoon returns true for dates within 7 days
- Test isDueSoon returns false for dates >7 days away
- Test isDueSoon returns false for overdue dates
- Test TaskCard renders vendor name correctly
- Test TaskCard renders amount with correct formatting
- Test TaskCard shows relative date ("in 2 days")
- Test TaskCard shows "Due Soon" badge when applicable
- Test TaskCard does not show badge when not due soon
- Test TaskCard displays bill type icon
- Test TaskCard is clickable and navigates correctly
- Test UpcomingTasks fetches tasks with correct query
- Test UpcomingTasks sorts by due date ascending
- Test UpcomingTasks limits to 10 tasks
- Test empty state when no tasks
- Test "View all" link appears when 10+ tasks
- Test pagination/load more functionality
- Mock getServerSession for authenticated tests
- Mock Prisma queries with test data

**Test Scenarios:**
1. **No tasks**: Show empty state with CTA
2. **<10 tasks**: Display all tasks, no pagination
3. **10+ tasks**: Display 10 tasks + "View all" link
4. **Due soon tasks**: Badge displayed correctly
5. **Not due soon**: No badge shown
6. **Task card click**: Navigate to task detail page
7. **Date formatting**: Relative and absolute dates correct
8. **Currency formatting**: Amount displays as ฿1,500.00
9. **Bill type icons**: Correct icon for each bill type
10. **Server component**: Data fetches on server, no hydration errors

**Mock Data Example:**
```typescript
const mockTasks = [
  {
    id: '1',
    userId: 'user1',
    status: 'UNPAID',
    dueDate: addDays(new Date(), 3),
    bill: {
      id: 'bill1',
      vendor: 'MEA',
      amount: 1500.00,
      billType: 'ELECTRIC'
    }
  },
  // ... more mock tasks
];
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation from Epic 5 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
