# User Story 7.2: Specify Recurrence Scheduling Details

**Story ID:** US-7.2
**Epic:** [EPIC-7: Recurring Reminders](epic-7-recurring-reminders.md)
**Priority:** Medium (P2)
**Status:** Ready for Development

---

## User Story

**As a** user
**I want to** specify details like day of week or day of month
**So that** recurring bills are created on the correct date

---

## Story Context

**Existing System Integration:**
- Integrates with: Recurrence form (US-7.1), Bill recurrence settings
- Technology: Next.js, React, date-fns/dayjs
- Follows pattern: Conditional form fields based on selection
- Touch points: RecurrenceSelector component, date calculation utilities

---

## Acceptance Criteria

**Functional Requirements:**

1. **For Weekly recurrence:**
   - Show day-of-week selector (Mon, Tue, Wed, etc.)
   - Store in `recurrence.dayOfWeek` (0-6, 0=Sunday)
   - Example: "Every Monday"

2. **For Monthly recurrence:**
   - Show day-of-month input (1-31)
   - Store in `recurrence.dayOfMonth` (1-31)
   - Handle edge cases (e.g., day 31 in February → last day of month)
   - Example: "Every 15th of the month"

3. **For Yearly recurrence:**
   - Show month selector (Jan-Dec) and day input
   - Store in `recurrence.monthOfYear` (1-12) and `recurrence.dayOfMonth`
   - Example: "Every January 1st"

4. Preview text shown: "Next bill will be created on: [date]"
5. Validation: Ensure day/month values are valid

**Integration Requirements:**

6. Existing recurrence form functionality continues to work unchanged
7. New scheduling fields follow existing form component pattern
8. Integration with RecurrenceSelector maintains current behavior

**Quality Requirements:**

9. Change is covered by appropriate tests
10. Documentation is updated if needed
11. No regression in existing functionality verified

---

## Technical Notes

**Date Calculation Function:**
```typescript
// lib/utils/recurrence.ts
export function calculateNextRecurrenceDate(
  recurrence: RecurrenceSettings,
  lastDate: Date
): Date {
  // Implementation based on recurrence.type
  // Handle edge cases (invalid dates, month end)

  switch (recurrence.type) {
    case 'WEEKLY':
      // Calculate next occurrence based on dayOfWeek
      break;
    case 'MONTHLY':
      // Calculate next occurrence based on dayOfMonth
      // Handle edge case: day 31 in February
      break;
    case 'YEARLY':
      // Calculate next occurrence based on monthOfYear + dayOfMonth
      break;
  }
}
```

**Preview Calculation:**
```typescript
const nextDate = calculateNextRecurrenceDate(recurrence, new Date());
// Display: "Next bill will be created on: October 15, 2025"
```

- **Integration Approach:** Extend RecurrenceSelector with conditional fields based on frequency type
- **Utility Location:** `lib/utils/recurrence.ts` for date calculations
- **Date Library:** Use date-fns or dayjs for date manipulations
- **Existing Pattern Reference:** Follow conditional form field patterns
- **Key Constraints:**
  - Edge case handling for invalid dates (e.g., Feb 30 → Feb 28/29)
  - Preview updates in real-time as user changes settings
  - Validation prevents impossible dates

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Date calculation errors for edge cases (leap years, month-end)
- **Mitigation:** Comprehensive unit tests, use battle-tested date library (date-fns), explicit edge case handling
- **Rollback:** Remove scheduling detail fields, use simple recurrence without specific dates

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] Database changes are additive only (fields within existing JSONB)
- [x] UI changes follow existing design patterns (conditional form fields)
- [x] Performance impact is negligible (client-side calculations)

---

## Definition of Done

- [ ] Functional requirements met (AC 1-5)
- [ ] Integration requirements verified (AC 6-8)
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Weekly: Day-of-week selector functional
- [ ] Monthly: Day-of-month input validates (1-31)
- [ ] Yearly: Month + day selectors functional
- [ ] Preview text displays correct next recurrence date
- [ ] Edge cases handled (Feb 31 → Feb 28/29, leap years)
- [ ] Form validation prevents invalid dates
- [ ] Unit tests for `calculateNextRecurrenceDate` function
- [ ] All edge cases tested (month-end, leap years, invalid dates)
- [ ] Documentation updated if applicable

---

## Dependencies

**Upstream Dependencies:**
- US-7.1: Requires recurrence frequency selection UI foundation

**Downstream Dependencies:**
- Background worker: Uses `calculateNextRecurrenceDate` for bill creation

---

## Notes

- **UI Components:** Use shadcn/ui Select for dropdowns, Input for numeric fields
- **Date Library:** Prefer date-fns for tree-shaking and functional API
- **Edge Cases to Test:**
  - February 30/31 → February 28 (or 29 in leap years)
  - Leap years (February 29)
  - Day 31 in months with 30 days
  - Timezone handling (user's local timezone)
- **Preview Format:** Use human-readable format: "October 15, 2025" (not ISO format)
- **Validation Rules:**
  - Weekly: dayOfWeek 0-6
  - Monthly: dayOfMonth 1-31
  - Yearly: monthOfYear 1-12, dayOfMonth 1-31
- **Future Enhancements:**
  - "Last day of month" option for monthly recurrence
  - "First/Second/Third/Last [weekday] of month" (e.g., "First Monday")
  - Custom recurrence patterns (every 2 weeks on Monday and Thursday)
