# US-3.2: LINE Notification When Bill Due Date Reached

**Story ID:** US-3.2
**Epic:** [Epic 3: Notifications](epic-3-notifications.md)
**Priority:** High (P1)
**Story Points:** 8
**Status:** Ready for Development

---

## User Story

**As a** user
**I want to** receive LINE notifications when bills reach their due date
**So that** I don't forget to pay them on time

---

## Acceptance Criteria

- [ ] Scheduled notification sent when bill due date is reached
- [ ] Notification contains:
  - [ ] "Bill due today!" message
  - [ ] Bill vendor name
  - [ ] Bill amount
  - [ ] Deep link to pay/mark task as paid
- [ ] Notification only sent if task status = UNPAID
- [ ] Notification scheduled via Bull queue (due date - current time)
- [ ] Notification record created (type: DUE_TODAY, status: SENT)
- [ ] Optional: Additional notification sent 1 day before due (type: DUE_SOON)
- [ ] Failed notifications retried 3 times with exponential backoff
- [ ] Job removed from queue if task marked PAID

---

## Technical Implementation

### Install Dependencies

```bash
npm install bull @bull-board/express @bull-board/api ioredis
npm install -D @types/bull
```

### Queue Configuration

**File:** `lib/queues/billNotifications.queue.ts`

```typescript
import Bull from "bull";
import Redis from "ioredis";

const redisConfig = {
  host: process.env.REDIS_HOST || "localhost",
  port: parseInt(process.env.REDIS_PORT || "6379"),
  maxRetriesPerRequest: null,
};

export const billNotificationsQueue = new Bull("billNotifications", {
  redis: redisConfig,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: "exponential",
      delay: 2000, // 2s, 4s, 8s
    },
    removeOnComplete: true,
    removeOnFail: false,
  },
});

// Job types
export interface DueNotificationJob {
  taskId: string;
  type: "DUE_SOON" | "DUE_TODAY";
}
```

### Queue Worker

**File:** `lib/queues/workers/billNotifications.worker.ts`

```typescript
import {
  billNotificationsQueue,
  DueNotificationJob,
} from "../billNotifications.queue";
import { prisma } from "@/lib/prisma";
import axios from "axios";

const LINE_CHANNEL_ACCESS_TOKEN = process.env.LINE_CHANNEL_ACCESS_TOKEN!;
const LINE_MESSAGING_API_URL = "https://api.line.me/v2/bot/message/push";
const LIFF_ID = process.env.NEXT_PUBLIC_LIFF_ID!;

billNotificationsQueue.process(async (job) => {
  const { taskId, type } = job.data as DueNotificationJob;

  console.log(`Processing ${type} notification for task ${taskId}`);

  // Fetch task with related data
  const task = await prisma.task.findUnique({
    where: { id: taskId },
    include: {
      bill: true,
      user: true,
    },
  });

  if (!task) {
    throw new Error(`Task ${taskId} not found`);
  }

  // Skip if task already paid
  if (task.status === "PAID") {
    console.log(`Task ${taskId} already paid, skipping notification`);
    return { skipped: true, reason: "already_paid" };
  }

  // Get user's LINE ID
  if (!task.user.lineUserId) {
    throw new Error(`User ${task.userId} has no LINE ID`);
  }

  // Create notification record
  const notification = await prisma.notification.create({
    data: {
      userId: task.userId,
      taskId: task.id,
      type,
      status: "PENDING",
      message: `${type === "DUE_TODAY" ? "Bill due today" : "Bill due soon"}: ${
        task.bill.vendor
      }`,
      metadata: {
        billId: task.billId,
        taskId: task.id,
      },
    },
  });

  try {
    // Create Flex Message
    const message = createDueNotificationFlexMessage(task, type);

    // Send to LINE
    await axios.post(
      LINE_MESSAGING_API_URL,
      {
        to: task.user.lineUserId,
        messages: [message],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${LINE_CHANNEL_ACCESS_TOKEN}`,
        },
      }
    );

    // Update notification status
    await prisma.notification.update({
      where: { id: notification.id },
      data: {
        status: "SENT",
        sentAt: new Date(),
      },
    });

    console.log(`‚úÖ ${type} notification sent for task ${taskId}`);
    return { success: true, notificationId: notification.id };
  } catch (error) {
    // Update notification status to failed
    await prisma.notification.update({
      where: { id: notification.id },
      data: { status: "FAILED" },
    });

    // Re-throw to trigger Bull retry
    throw error;
  }
});

function createDueNotificationFlexMessage(task: any, type: string) {
  const deepLink = `https://liff.line.me/${LIFF_ID}?path=/tasks/${task.id}`;
  const billTypeIcon = getBillTypeIcon(task.bill.type);
  const formattedAmount = `‡∏ø${task.bill.amount.toLocaleString("th-TH", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })}`;
  const formattedDate = new Date(task.dueDate).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });

  const title =
    type === "DUE_TODAY" ? "‚ö†Ô∏è Bill Due Today!" : "‚è∞ Bill Due Soon";
  const color = type === "DUE_TODAY" ? "#FF6B6B" : "#FFA500";

  return {
    type: "flex",
    altText: `${title}: ${task.bill.vendor}`,
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          {
            type: "text",
            text: title,
            weight: "bold",
            size: "xl",
            color,
          },
          {
            type: "box",
            layout: "vertical",
            margin: "lg",
            spacing: "sm",
            contents: [
              {
                type: "box",
                layout: "baseline",
                spacing: "sm",
                contents: [
                  {
                    type: "text",
                    text: billTypeIcon,
                    size: "xl",
                    flex: 0,
                  },
                  {
                    type: "text",
                    text: task.bill.vendor,
                    weight: "bold",
                    size: "lg",
                    flex: 1,
                  },
                ],
              },
              {
                type: "box",
                layout: "baseline",
                spacing: "sm",
                contents: [
                  {
                    type: "text",
                    text: "Amount:",
                    color: "#aaaaaa",
                    size: "sm",
                    flex: 1,
                  },
                  {
                    type: "text",
                    text: formattedAmount,
                    weight: "bold",
                    size: "md",
                    color: "#FF6B6B",
                    flex: 2,
                    align: "end",
                  },
                ],
              },
              {
                type: "box",
                layout: "baseline",
                spacing: "sm",
                contents: [
                  {
                    type: "text",
                    text: "Due Date:",
                    color: "#aaaaaa",
                    size: "sm",
                    flex: 1,
                  },
                  {
                    type: "text",
                    text: formattedDate,
                    size: "sm",
                    flex: 2,
                    align: "end",
                  },
                ],
              },
            ],
          },
        ],
      },
      footer: {
        type: "box",
        layout: "vertical",
        spacing: "sm",
        contents: [
          {
            type: "button",
            style: "primary",
            color: "#FF6B6B",
            action: {
              type: "uri",
              label: "Pay Now",
              uri: deepLink,
            },
          },
        ],
      },
    },
  };
}

function getBillTypeIcon(type: string): string {
  const icons: Record<string, string> = {
    electricity: "‚ö°",
    water: "üíß",
    internet: "üåê",
    car: "üöó",
    rent: "üè†",
  };
  return icons[type] || "üìÑ";
}

// Graceful shutdown
process.on("SIGTERM", async () => {
  console.log("SIGTERM received, closing queue...");
  await billNotificationsQueue.close();
  process.exit(0);
});
```

### Schedule Notification on Task Creation

**File:** `lib/services/notificationScheduler.ts`

```typescript
import { billNotificationsQueue } from "../queues/billNotifications.queue";

export async function scheduleTaskNotifications(taskId: string, dueDate: Date) {
  const now = new Date();
  const dueDateMs = dueDate.getTime();
  const nowMs = now.getTime();

  // Schedule DUE_TODAY notification (at due date)
  if (dueDateMs > nowMs) {
    const delay = dueDateMs - nowMs;
    await billNotificationsQueue.add(
      { taskId, type: "DUE_TODAY" },
      {
        delay,
        jobId: `due-today-${taskId}`, // Unique job ID for deduplication
      }
    );
    console.log(
      `Scheduled DUE_TODAY notification for task ${taskId} in ${delay}ms`
    );
  }

  // Schedule DUE_SOON notification (1 day before due date)
  const oneDayBeforeMs = dueDateMs - 24 * 60 * 60 * 1000;
  if (oneDayBeforeMs > nowMs) {
    const delay = oneDayBeforeMs - nowMs;
    await billNotificationsQueue.add(
      { taskId, type: "DUE_SOON" },
      {
        delay,
        jobId: `due-soon-${taskId}`,
      }
    );
    console.log(
      `Scheduled DUE_SOON notification for task ${taskId} in ${delay}ms`
    );
  }
}
```

**Update:** `app/api/bills/route.ts`

```typescript
import { scheduleTaskNotifications } from "@/lib/services/notificationScheduler";

// Inside POST handler, after transaction:
const result = await prisma.$transaction(async (tx) => {
  // ... create bill and task
  return { bill, task };
});

// Schedule due date notifications
await scheduleTaskNotifications(result.task.id, result.task.dueDate);
```

### Remove Job When Task Marked Paid

**File:** `app/api/tasks/[id]/mark-paid/route.ts`

```typescript
import { billNotificationsQueue } from "@/lib/queues/billNotifications.queue";

export async function PATCH(
  req: Request,
  { params }: { params: { id: string } }
) {
  // ... mark task as paid

  // Remove pending notification jobs
  await billNotificationsQueue.removeJobs(`due-today-${params.id}`);
  await billNotificationsQueue.removeJobs(`due-soon-${params.id}`);

  return NextResponse.json({ success: true });
}
```

### Worker Script

**File:** `scripts/start-worker.ts`

```typescript
import "../lib/queues/workers/billNotifications.worker";

console.log("üöÄ Bill notifications worker started");
```

**File:** `package.json`

```json
{
  "scripts": {
    "worker": "tsx watch scripts/start-worker.ts",
    "dev:all": "concurrently \"npm run dev\" \"npm run worker\""
  }
}
```

---

## Bull Board (Optional Monitoring)

**File:** `app/api/admin/queues/route.ts`

```typescript
import { createBullBoard } from "@bull-board/api";
import { BullAdapter } from "@bull-board/api/bullAdapter";
import { ExpressAdapter } from "@bull-board/express";
import { billNotificationsQueue } from "@/lib/queues/billNotifications.queue";

const serverAdapter = new ExpressAdapter();
serverAdapter.setBasePath("/api/admin/queues");

createBullBoard({
  queues: [new BullAdapter(billNotificationsQueue)],
  serverAdapter,
});

export const GET = serverAdapter.getRouter();
```

Access at: `http://localhost:3000/api/admin/queues`

---

## Technical Notes

- **Bull Queue:** Redis-backed job queue for scheduled notifications
- **Retry Logic:** 3 attempts with exponential backoff (2s, 4s, 8s)
- **Job Deduplication:** Unique job IDs prevent duplicate notifications
- **Cleanup:** Jobs removed when task marked paid
- **Worker Process:** Separate process monitors queue and executes jobs

---

## Dependencies

**Upstream:**

- Epic 2 US-2.1: Task creation triggers notification scheduling
- Epic 9 (Login & Auth): User's LINE ID required

**Downstream:**

- Epic 4 (Task Actions): Mark paid cancels scheduled notifications

**External:**

- Redis server running (localhost:6379)
- LINE Messaging API credentials
- Worker process running

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Bull queue configured and tested
- [ ] Worker process implemented
- [ ] Notifications scheduled on task creation
- [ ] Jobs removed when task marked paid
- [ ] Retry logic working
- [ ] LINE API integration tested
- [ ] Unit tests passing
- [ ] E2E tests passing
- [ ] Worker startup documented
- [ ] Code reviewed and merged

---

## Environment Setup

### Start Redis

```bash
# macOS (Homebrew)
brew install redis
brew services start redis

# Verify running
redis-cli ping
# Should return: PONG
```

### Environment Variables

```bash
REDIS_HOST=localhost
REDIS_PORT=6379
```

### Start Worker

```bash
npm run worker
# OR run both dev server and worker:
npm run dev:all
```

---

## Risk Assessment

**Primary Risk:** Redis down or worker not running ‚Üí notifications not sent
**Mitigation:**

- Health check endpoint to verify Redis connection
- Bull Board to monitor failed jobs
- Clear documentation for starting worker

**Secondary Risk:** Jobs not removed when task paid ‚Üí duplicate notifications
**Mitigation:**

- Unique job IDs for deduplication
- Worker checks task status before sending
- Explicit job removal on mark paid

---

## Notes

- **Critical Setup:** Redis and worker must run for notifications to work
- **Development:** Use `npm run dev:all` to start both server and worker
- **Production:** Use PM2 or similar to manage worker process
- **Monitoring:** Bull Board provides UI to inspect queues and failed jobs
- **Future Enhancement:** Consider daily digest for multiple due bills
