# Story 9.1: Log In with LINE

**Epic:** EPIC-9 - Login & Authentication
**Story ID:** US-9.1
**Priority:** Critical (P0)
**Status:** Draft

---

## Story

**As a** user,
**I want** to log in with LINE,
**so that** I can access my bill tracking without creating a new account

---

## Acceptance Criteria

1. Landing page shows "Login with LINE" button (prominent)
2. Click button redirects to LINE OAuth consent screen
3. LINE consent screen shows:
   - App name and logo
   - Requested permissions (profile access)
   - Allow/Deny buttons
4. User clicks "Allow" → redirected back to app
5. App receives LINE user ID and profile data
6. User record created/updated in database
7. Session created with NextAuth.js
8. User redirected to dashboard after successful login
9. Session persists across page refreshes
10. "Login with LINE" button hidden when already logged in
11. Graceful error handling if LINE OAuth fails

---

## Tasks / Subtasks

- [ ] Set up LINE Developer Console configuration (AC: 2, 3, 5)
  - [ ] Create LINE Official Account
  - [ ] Create LINE Login channel
  - [ ] Configure Callback URL: `{NEXTAUTH_URL}/api/auth/callback/line`
  - [ ] Get Channel ID and Channel Secret
  - [ ] Create LIFF app and get LIFF ID
  - [ ] Enable "openid" and "profile" scopes
  - [ ] Add developer accounts for testing

- [ ] Install and configure NextAuth.js (AC: 7, 9)
  - [ ] Install next-auth package
  - [ ] Create `lib/auth.ts` with authOptions
  - [ ] Configure LINE provider with credentials
  - [ ] Set up session callbacks
  - [ ] Configure session storage (httpOnly cookies)

- [ ] Create User database model (AC: 6)
  - [ ] Define User schema/model
  - [ ] Add fields: id, lineUserId, name, avatarUrl, timestamps
  - [ ] Create unique index on lineUserId
  - [ ] Run database migration

- [ ] Implement NextAuth API route (AC: 4, 5, 6, 7)
  - [ ] Create `app/api/auth/[...nextauth]/route.ts`
  - [ ] Configure LINE provider in authOptions
  - [ ] Implement signIn callback (create/update user)
  - [ ] Implement session callback (add user ID)
  - [ ] Handle OAuth errors gracefully

- [ ] Create landing page with login button (AC: 1, 2)
  - [ ] Design landing page layout
  - [ ] Add "Login with LINE" button (prominent)
  - [ ] Style button with LINE branding
  - [ ] Link button to NextAuth signIn
  - [ ] Show loading state during redirect

- [ ] Implement session persistence (AC: 9, 10)
  - [ ] Configure session strategy (JWT)
  - [ ] Set session max age (30 days)
  - [ ] Test session across page refreshes
  - [ ] Hide login button when authenticated

- [ ] Add protected route middleware (AC: 8)
  - [ ] Create `middleware.ts`
  - [ ] Configure matcher for protected routes
  - [ ] Redirect unauthenticated users to landing page

- [ ] Implement post-login redirect (AC: 8)
  - [ ] Configure callbackUrl to dashboard
  - [ ] Handle redirect after successful login
  - [ ] Preserve intended destination URL

- [ ] Add error handling (AC: 11)
  - [ ] Handle LINE OAuth denial
  - [ ] Handle network errors
  - [ ] Handle invalid credentials
  - [ ] Display user-friendly error messages
  - [ ] Provide retry option

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Auth Framework: NextAuth.js v5
- OAuth Provider: LINE Login
- Session Storage: HTTP-only cookies (secure, sameSite=lax)
- Database: User model in PostgreSQL/SQLite

**Integration Points:**
- LINE Login API (OAuth 2.0)
- LINE LIFF SDK (for in-app browser)
- User database table
- Protected route middleware
- All epics depend on this authentication

**Key Implementation Details:**

**Environment Variables:**
```bash
# LINE OAuth
LINE_CLIENT_ID="your-line-client-id"
LINE_CLIENT_SECRET="your-line-client-secret"
NEXT_PUBLIC_LINE_LIFF_ID="your-liff-id"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generate-with-openssl-rand-base64-32"
```

**User Database Schema:**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  line_user_id VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**NextAuth Configuration (`lib/auth.ts`):**
```typescript
import NextAuth from 'next-auth';
import LineProvider from 'next-auth/providers/line';

export const authOptions = {
  providers: [
    LineProvider({
      clientId: process.env.LINE_CLIENT_ID!,
      clientSecret: process.env.LINE_CLIENT_SECRET!,
    }),
  ],
  callbacks: {
    async signIn({ user, account, profile }) {
      // Create or update user in database
      const existingUser = await prisma.user.findUnique({
        where: { lineUserId: profile.sub }
      });

      if (!existingUser) {
        await prisma.user.create({
          data: {
            lineUserId: profile.sub,
            name: profile.name,
            avatarUrl: profile.picture
          }
        });
      } else {
        await prisma.user.update({
          where: { lineUserId: profile.sub },
          data: {
            name: profile.name,
            avatarUrl: profile.picture
          }
        });
      }

      return true;
    },
    async session({ session, token }) {
      // Add user ID to session
      if (token.sub) {
        const user = await prisma.user.findUnique({
          where: { lineUserId: token.sub }
        });
        session.user.id = user?.id;
      }
      return session;
    }
  }
};
```

**Middleware Configuration (`middleware.ts`):**
```typescript
export { default } from 'next-auth/middleware';

export const config = {
  matcher: ['/dashboard/:path*', '/tasks/:path*', '/bills/:path*']
};
```

**LINE OAuth Flow:**
1. User clicks "Login with LINE" button
2. Redirect to LINE OAuth consent screen
3. User approves access (profile, openid scopes)
4. LINE redirects back with authorization code
5. NextAuth exchanges code for access token
6. NextAuth retrieves user profile from LINE
7. signIn callback creates/updates user in database
8. Session created and stored in httpOnly cookie
9. User redirected to dashboard

**Security Features:**
- httpOnly cookies prevent XSS access
- sameSite=lax prevents CSRF
- CSRF tokens automatically handled by NextAuth
- Secure flag in production (HTTPS)
- Session encryption with NEXTAUTH_SECRET

**LINE LIFF vs Web Login:**
- Use LIFF for in-app browser (LINE app)
- Fallback to web OAuth for desktop browsers
- Detect environment and use appropriate method

### Testing

**Test Location:** `__tests__/auth/` and `__tests__/api/auth/`

**Testing Standards:**
- Integration tests for OAuth flow
- Unit tests for signIn callback logic
- Unit tests for session callback
- E2E test for full login flow
- Test session persistence

**Testing Frameworks:**
- Jest for unit tests
- Supertest for API testing
- Playwright/Cypress for E2E tests
- Mock LINE OAuth responses

**Specific Requirements:**
- Test successful login flow
- Test user creation on first login
- Test user update on subsequent logins
- Test session persistence across refreshes
- Test protected route middleware
- Test unauthenticated redirect
- Test OAuth error handling (user denies)
- Test network error handling
- Test invalid credentials
- Test session expiration
- Mock LINE OAuth provider
- Test LIFF initialization (if applicable)

**Test Scenarios:**
1. **First-time login**: User doesn't exist → create user → create session
2. **Returning user**: User exists → update profile → create session
3. **OAuth denial**: User denies → show error → allow retry
4. **Network error**: API timeout → show error → allow retry
5. **Protected route**: Unauthenticated → redirect to landing page
6. **Session persistence**: Login → refresh page → still authenticated
7. **Already logged in**: Hide login button → show user info

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
