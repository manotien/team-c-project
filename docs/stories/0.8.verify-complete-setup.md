# Story 0.8: Verify Complete Setup

**Epic:** Epic 0 - Project Initialization & Setup
**Story ID:** US-0.8
**Priority:** Critical (P0)
**Estimate:** 1 hour

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to run a comprehensive verification checklist,
**so that** I know the environment is fully functional before feature development.

---

## Acceptance Criteria

1. Next.js dev server starts successfully without errors
2. Dev server accessible at `http://localhost:3000`
3. Database connection verified (Prisma Studio opens)
4. All database tables visible (users, bills, tasks, notifications)
5. Redis connection verified (`redis-cli ping` returns PONG)
6. Authentication flow works (LINE OAuth redirect in sandbox)
7. Session created and persisted across page refreshes
8. Protected routes require authentication
9. Document AI test call succeeds with sample receipt
10. LINE Messaging API test message sends successfully
11. All tests pass (`pnpm test`)
12. Build succeeds without errors (`pnpm build`)
13. No TypeScript errors (`pnpm type-check`)
14. No ESLint errors (`pnpm lint`)

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Next.js dev server** (AC: 1, 2)
  - [ ] Run `pnpm dev`
  - [ ] Check console for errors
  - [ ] Open browser: `http://localhost:3000`
  - [ ] Verify page loads (Next.js welcome or placeholder)
  - [ ] Check for TypeScript compilation errors
  - [ ] Verify hot reload works (edit a file, check refresh)

- [ ] **Task 2: Verify database connection** (AC: 3, 4)
  - [ ] Run `pnpm prisma studio` in separate terminal
  - [ ] Verify Prisma Studio opens at `http://localhost:5555`
  - [ ] Check all tables visible: users, bills, tasks, notifications
  - [ ] Create test user record manually
  - [ ] Verify record saved successfully
  - [ ] Delete test record

- [ ] **Task 3: Verify Redis connection** (AC: 5)
  - [ ] Run `redis-cli ping` in terminal
  - [ ] Verify returns "PONG"
  - [ ] Test SET command: `redis-cli SET test "hello"`
  - [ ] Test GET command: `redis-cli GET test`
  - [ ] Cleanup: `redis-cli DEL test`

- [ ] **Task 4: Verify authentication flow** (AC: 6, 7, 8)
  - [ ] Navigate to `/api/auth/signin`
  - [ ] Click "Sign in with LINE"
  - [ ] Verify redirect to LINE OAuth consent
  - [ ] Complete LINE sandbox authentication
  - [ ] Verify redirect back to app
  - [ ] Check user created in Prisma Studio
  - [ ] Verify session cookie in browser DevTools
  - [ ] Refresh page - verify session persists
  - [ ] Try accessing `/dashboard` - should be allowed
  - [ ] Sign out: `/api/auth/signout`
  - [ ] Try accessing `/dashboard` - should redirect to login

- [ ] **Task 5: Verify Document AI** (AC: 9)
  - [ ] Place sample receipt in `tests/fixtures/sample-receipt.jpg`
  - [ ] Run `tsx scripts/test-ocr.ts`
  - [ ] Verify OCR output printed to console
  - [ ] Check extracted entities (vendor, amount, date)
  - [ ] Verify confidence scores ‚â• 60%
  - [ ] No API errors or exceptions

- [ ] **Task 6: Verify LINE Messaging API** (AC: 10)
  - [ ] Get your LINE User ID (from profile or LIFF)
  - [ ] Update `scripts/test-line-message.ts` with your ID
  - [ ] Run `tsx scripts/test-line-message.ts`
  - [ ] Verify success message in console
  - [ ] Check LINE app for test message
  - [ ] Verify message received within seconds

- [ ] **Task 7: Run all tests** (AC: 11)
  - [ ] Run `pnpm test`
  - [ ] Verify all unit tests pass
  - [ ] Check test output for failures
  - [ ] Run `pnpm test:e2e` (if any E2E tests exist)
  - [ ] Verify E2E tests pass

- [ ] **Task 8: Verify build** (AC: 12)
  - [ ] Run `pnpm build`
  - [ ] Verify build completes without errors
  - [ ] Check build output shows pages/routes
  - [ ] Verify bundle size reasonable (<1MB total)
  - [ ] No TypeScript errors during build

- [ ] **Task 9: Run linting and type checking** (AC: 13, 14)
  - [ ] Run `pnpm type-check`
  - [ ] Verify no TypeScript errors
  - [ ] Run `pnpm lint`
  - [ ] Verify no ESLint errors
  - [ ] Run `pnpm format` to ensure consistent formatting

- [ ] **Task 10: Create comprehensive verification checklist**
  - [ ] Document all verification steps in README
  - [ ] Create `scripts/verify-setup.ts` that runs all checks
  - [ ] Output clear success/failure indicators
  - [ ] Exit with error code on any failure

---

## Dev Notes

### Comprehensive Verification Script (scripts/verify-setup.ts)

```typescript
#!/usr/bin/env tsx

import { exec } from 'child_process';
import { promisify } from 'util';
import fs from 'fs';

const execAsync = promisify(exec);

interface CheckResult {
  name: string;
  status: 'pass' | 'fail' | 'warn';
  message: string;
}

const results: CheckResult[] = [];

async function check(
  name: string,
  fn: () => Promise<void>,
  critical = true
): Promise<void> {
  try {
    await fn();
    results.push({ name, status: 'pass', message: 'OK' });
    console.log(`‚úÖ ${name}`);
  } catch (error: any) {
    const status = critical ? 'fail' : 'warn';
    results.push({ name, status, message: error.message });
    console.log(`${critical ? '‚ùå' : '‚ö†Ô∏è '} ${name}: ${error.message}`);
  }
}

async function runVerification() {
  console.log('üîç Running comprehensive setup verification...\n');

  // Check Node.js version
  await check('Node.js version (18+)', async () => {
    const { stdout } = await execAsync('node --version');
    const version = parseInt(stdout.replace('v', '').split('.')[0]);
    if (version < 18) throw new Error(`Node ${version} < 18`);
  });

  // Check pnpm installed
  await check('pnpm installed', async () => {
    await execAsync('pnpm --version');
  });

  // Check PostgreSQL running
  await check('PostgreSQL running', async () => {
    await execAsync('pg_isready');
  });

  // Check Redis running
  await check('Redis running', async () => {
    const { stdout } = await execAsync('redis-cli ping');
    if (!stdout.includes('PONG')) throw new Error('Redis not responding');
  });

  // Check database exists
  await check('Database exists', async () => {
    await execAsync('psql -d household_bills -c "SELECT 1"');
  });

  // Check Prisma Client generated
  await check('Prisma Client generated', async () => {
    if (!fs.existsSync('./node_modules/.prisma/client')) {
      throw new Error('Run: pnpm prisma generate');
    }
  });

  // Check environment variables
  await check('Environment variables', async () => {
    const required = [
      'DATABASE_URL',
      'NEXTAUTH_SECRET',
      'LINE_CLIENT_ID',
      'GCP_PROJECT_ID',
    ];
    const missing = required.filter((v) => !process.env[v]);
    if (missing.length > 0) {
      throw new Error(`Missing: ${missing.join(', ')}`);
    }
  });

  // Check GCP credentials file
  await check('GCP credentials file', async () => {
    if (!fs.existsSync('./gcp-credentials.json')) {
      throw new Error('gcp-credentials.json not found');
    }
  }, false); // Non-critical

  // Check TypeScript compilation
  await check('TypeScript compilation', async () => {
    await execAsync('pnpm type-check');
  });

  // Check ESLint
  await check('ESLint', async () => {
    await execAsync('pnpm lint');
  });

  // Check tests
  await check('Unit tests', async () => {
    await execAsync('pnpm test run');
  }, false); // Non-critical if no tests yet

  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('üìä Verification Summary\n');

  const passed = results.filter((r) => r.status === 'pass').length;
  const failed = results.filter((r) => r.status === 'fail').length;
  const warned = results.filter((r) => r.status === 'warn').length;

  console.log(`‚úÖ Passed: ${passed}`);
  if (warned > 0) console.log(`‚ö†Ô∏è  Warnings: ${warned}`);
  if (failed > 0) console.log(`‚ùå Failed: ${failed}`);

  console.log('='.repeat(50) + '\n');

  if (failed > 0) {
    console.log('‚ùå Setup verification failed. Please fix the errors above.\n');
    process.exit(1);
  } else {
    console.log('‚úÖ Setup verification passed! Ready for development.\n');
    process.exit(0);
  }
}

runVerification();
```

### Manual Verification Checklist

**Before starting feature development, verify:**

**‚úÖ Services Running:**
- [ ] PostgreSQL running: `pg_isready`
- [ ] Redis running: `redis-cli ping`
- [ ] Database created: `psql -l | grep household_bills`

**‚úÖ Development Environment:**
- [ ] Dev server starts: `pnpm dev`
- [ ] No TypeScript errors in console
- [ ] Hot reload works
- [ ] Port 3000 accessible

**‚úÖ Database:**
- [ ] Prisma Studio opens: `pnpm prisma studio`
- [ ] All tables visible (4 tables)
- [ ] Can create/read records
- [ ] Relationships work

**‚úÖ Authentication:**
- [ ] LINE Login channel configured
- [ ] LIFF app created
- [ ] OAuth flow completes
- [ ] User record created in database
- [ ] Session persists

**‚úÖ External Services:**
- [ ] Document AI returns OCR data
- [ ] LINE Messaging sends test message
- [ ] GCP credentials valid
- [ ] Free tier limits understood

**‚úÖ Code Quality:**
- [ ] TypeScript: `pnpm type-check` ‚úÖ
- [ ] ESLint: `pnpm lint` ‚úÖ
- [ ] Prettier: `pnpm format` ‚úÖ
- [ ] Tests: `pnpm test` ‚úÖ
- [ ] Build: `pnpm build` ‚úÖ

**‚úÖ Documentation:**
- [ ] README.md complete
- [ ] Setup instructions clear
- [ ] Environment variables documented
- [ ] All stories 0.1-0.7 completed

### README Verification Section

Add this section to README.md:

```markdown
## Verification

Run the comprehensive verification script to check your setup:

```bash
tsx scripts/verify-setup.ts
```

This will check:
- ‚úÖ Node.js and pnpm versions
- ‚úÖ PostgreSQL and Redis running
- ‚úÖ Database exists and accessible
- ‚úÖ Prisma Client generated
- ‚úÖ Environment variables configured
- ‚úÖ TypeScript compilation
- ‚úÖ ESLint passes
- ‚úÖ Tests pass

If all checks pass, you're ready to start development!

### Manual Verification

You can also verify individual components:

```bash
# Services
pg_isready              # PostgreSQL
redis-cli ping          # Redis

# Database
pnpm prisma studio      # Open database GUI

# Code quality
pnpm type-check         # TypeScript
pnpm lint               # ESLint
pnpm test               # Tests
pnpm build              # Production build

# External services
tsx scripts/test-ocr.ts             # Document AI
tsx scripts/test-line-message.ts    # LINE Messaging
```
```

### Common Issues and Solutions

**Port 3000 already in use:**
- Kill process: `lsof -ti:3000 | xargs kill -9`
- Or use different port: `PORT=3001 pnpm dev`

**PostgreSQL connection refused:**
- Check service: `brew services list` (macOS)
- Restart: `brew services restart postgresql@15`

**Redis connection refused:**
- Check service: `brew services list` (macOS)
- Restart: `brew services restart redis`

**Prisma Client not found:**
- Regenerate: `pnpm prisma generate`

**TypeScript errors:**
- Clear cache: `rm -rf .next`
- Reinstall: `pnpm install`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
