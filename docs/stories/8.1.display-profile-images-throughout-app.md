# Story 8.1: Display Profile Images Throughout App

**Epic:** EPIC-8 - Profile & Icons
**Story ID:** US-8.1
**Priority:** Low (P3)
**Status:** Draft

---

## Story

**As a** user,
**I want** to see profile images (my avatar) next to my tasks and in my profile,
**so that** the app feels personalized and I can quickly identify my content

---

## Acceptance Criteria

1. User avatar displayed in:
   - App header/navigation (top-right corner)
   - Monthly summary card (Epic 6)
   - User profile/settings page (if implemented)
   - Task detail page (task owner indication)
2. Avatar sourced from LINE profile (`user.avatarUrl`)
3. Avatar displayed as circular image (standard size: 40px)
4. Fallback avatar if no image available:
   - Show first letter of user's name in colored circle
   - or use default user icon (ðŸ‘¤)
5. Click avatar in header opens dropdown menu:
   - User name
   - "Settings" link (future)
   - "Logout" button
6. Avatar loads efficiently (Next.js Image optimization)
7. Avatar alt text includes user name for accessibility

---

## Tasks / Subtasks

- [ ] Create reusable Avatar component (AC: 2, 3, 4, 6, 7)
  - [ ] Create `components/ui/Avatar.tsx`
  - [ ] Accept props: src (image URL), name, size (default 40px)
  - [ ] Use Next.js Image component for optimization
  - [ ] Display circular image with rounded-full class
  - [ ] Implement fallback logic for missing/broken images
  - [ ] Show first letter of name in colored circle as fallback
  - [ ] Add alt text with user name for accessibility
  - [ ] Handle image loading errors gracefully

- [ ] Implement fallback avatar logic (AC: 4)
  - [ ] Extract first character from user name
  - [ ] Convert to uppercase
  - [ ] Generate consistent color from name
  - [ ] Create circular div with background color
  - [ ] Center letter in circle
  - [ ] Handle edge case: empty name

- [ ] Integrate avatar in Header component (AC: 1a, 5)
  - [ ] Update `components/layout/Header.tsx`
  - [ ] Fetch user session with getServerSession
  - [ ] Position avatar in top-right corner
  - [ ] Wrap avatar in dropdown trigger
  - [ ] Ensure header displays on all authenticated pages

- [ ] Create avatar dropdown menu (AC: 5)
  - [ ] Build DropdownMenu component (or use shadcn/ui)
  - [ ] Display user name as label
  - [ ] Add "Settings" menu item (link to /settings)
  - [ ] Add "Logout" menu item with signOut handler
  - [ ] Style dropdown appropriately
  - [ ] Position dropdown below avatar

- [ ] Display avatar in Monthly Summary card (AC: 1b)
  - [ ] Update Monthly Summary component (Epic 6)
  - [ ] Add Avatar component to summary header
  - [ ] Position near user name or title
  - [ ] Use smaller size if needed (32px)

- [ ] Display avatar in Task detail page (AC: 1d)
  - [ ] Update Task detail component
  - [ ] Add Avatar next to task owner name
  - [ ] Show "Created by [avatar] [name]"
  - [ ] Use small size (24px)

- [ ] Add User profile/settings page (AC: 1c - optional)
  - [ ] Create `/settings` page route
  - [ ] Display larger avatar (80px or 120px)
  - [ ] Show user name and email
  - [ ] Add placeholder for future settings

---

## Dev Notes

### Technical Context

**Tech Stack:**
- UI Library: shadcn/ui Avatar component (optional)
- Image Optimization: Next.js Image component
- Session: NextAuth.js getServerSession
- Styling: Tailwind CSS

**Integration Points:**
- Epic 9 (US-9.1, US-9.2): User profile data from LINE authentication
- Epic 6: Monthly summary card
- All authenticated pages: Header component
- Task detail pages: Task owner indication

**Key Implementation Details:**

**Avatar Component (`components/ui/Avatar.tsx`):**
```typescript
import Image from 'next/image';
import { useState } from 'react';

interface AvatarProps {
  src?: string | null;
  name: string;
  size?: number; // default 40px
  className?: string;
}

export function Avatar({ src, name, size = 40, className = '' }: AvatarProps) {
  const [imageError, setImageError] = useState(false);

  // Fallback: first letter in colored circle
  if (!src || imageError) {
    const initial = name?.charAt(0)?.toUpperCase() || '?';
    const bgColor = getColorFromName(name);

    return (
      <div
        className={`rounded-full flex items-center justify-center font-semibold text-white ${className}`}
        style={{
          width: size,
          height: size,
          backgroundColor: bgColor,
          fontSize: size * 0.5
        }}
        aria-label={`${name}'s avatar`}
      >
        {initial}
      </div>
    );
  }

  return (
    <Image
      src={src}
      alt={`${name}'s avatar`}
      width={size}
      height={size}
      className={`rounded-full object-cover ${className}`}
      onError={() => setImageError(true)}
      priority={size > 40} // Priority for large avatars
    />
  );
}

// Generate consistent color from name
function getColorFromName(name: string): string {
  const colors = [
    '#FF6B6B', // red
    '#4ECDC4', // teal
    '#45B7D1', // blue
    '#FFA07A', // orange
    '#98D8C8', // mint
    '#F7DC6F', // yellow
    '#BB8FCE', // purple
    '#85C1E2'  // light blue
  ];

  const hash = (name || '').split('').reduce((acc, char) => {
    return acc + char.charCodeAt(0);
  }, 0);

  return colors[hash % colors.length];
}
```

**Header Component with Avatar (`components/layout/Header.tsx`):**
```typescript
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { Avatar } from '@/components/ui/Avatar';
import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuLabel, DropdownMenuItem, DropdownMenuSeparator } from '@/components/ui/dropdown-menu';
import { signOut } from 'next-auth/react';

export async function Header() {
  const session = await getServerSession(authOptions);

  if (!session) {
    return null; // Or show login button
  }

  return (
    <header className="border-b">
      <div className="container mx-auto px-4 py-3 flex justify-between items-center">
        <nav>
          {/* Navigation links */}
        </nav>

        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <button className="focus:outline-none focus:ring-2 focus:ring-primary rounded-full">
              <Avatar
                src={session.user.image}
                name={session.user.name || 'User'}
                size={40}
              />
            </button>
          </DropdownMenuTrigger>

          <DropdownMenuContent align="end">
            <DropdownMenuLabel>{session.user.name}</DropdownMenuLabel>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <a href="/settings">Settings</a>
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => signOut({ callbackUrl: '/' })}>
              Logout
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    </header>
  );
}
```

**Usage in Monthly Summary (Epic 6):**
```typescript
<div className="flex items-center gap-2">
  <Avatar src={user.avatarUrl} name={user.name} size={32} />
  <h3>{user.name}'s Summary</h3>
</div>
```

**Usage in Task Detail:**
```typescript
<div className="flex items-center gap-2 text-sm text-muted-foreground">
  <span>Created by</span>
  <Avatar src={task.user.avatarUrl} name={task.user.name} size={24} />
  <span>{task.user.name}</span>
</div>
```

**Next.js Image Optimization:**
- Automatically optimizes images from LINE CDN
- Lazy loads images below the fold
- Uses priority prop for above-fold avatars
- Handles responsive images with srcset

**Accessibility:**
- Alt text: `{name}'s avatar`
- Keyboard navigation: Dropdown trigger focusable
- ARIA labels: `aria-label` on fallback avatars
- Focus visible: Ring outline on keyboard focus

### Dependencies

**Upstream Dependencies:**
- Epic 9 (US-9.1): User authentication and session
- Epic 9 (US-9.2): User avatar and name data from LINE

**Downstream Dependencies:**
- Epic 6: Monthly summary card integration
- Task detail pages across multiple epics

**Component Dependencies:**
- shadcn/ui DropdownMenu (or custom implementation)
- Next.js Image component
- NextAuth.js session utilities

### Testing

**Test Location:** `__tests__/components/ui/Avatar.test.tsx` and `__tests__/components/layout/Header.test.tsx`

**Testing Standards:**
- Unit tests for Avatar component
- Visual regression tests for fallback avatars
- Integration tests for Header dropdown
- Accessibility tests (WCAG AA)
- E2E tests for avatar display across pages

**Testing Frameworks:**
- Jest for unit tests
- React Testing Library for component tests
- Axe for accessibility testing
- Playwright/Cypress for E2E tests
- Mock NextAuth session

**Specific Requirements:**
- Test Avatar with valid image URL
- Test Avatar with broken/invalid image URL
- Test Avatar with null/undefined src
- Test Avatar with empty name (edge case)
- Test fallback shows correct initial letter
- Test fallback color generation is consistent
- Test Avatar sizes (24px, 32px, 40px, 80px)
- Test Header dropdown opens/closes
- Test dropdown menu items clickable
- Test logout functionality
- Test avatar displays in all locations:
  - Header
  - Monthly summary
  - Task detail
  - Settings page
- Test Next.js Image optimization applied
- Test alt text present and correct
- Test keyboard navigation
- Test focus states
- Mock getServerSession for tests

**Test Scenarios:**
1. **Avatar with image**: Display LINE profile picture correctly
2. **Avatar fallback**: Show first letter in colored circle
3. **Broken image**: Gracefully fallback when image fails to load
4. **Empty name**: Show "?" or default icon
5. **Color consistency**: Same name always gets same color
6. **Dropdown interaction**: Click avatar â†’ show menu â†’ click logout
7. **Responsive**: Avatar scales appropriately on mobile
8. **Performance**: Images load efficiently with Next.js optimization
9. **Accessibility**: Screen reader announces avatar correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation from Epic 8 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
