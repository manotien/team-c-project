# Story 6.1: Display Total Payments for Current Month

**Epic:** [Epic 6: Monthly Summary](epic-6-monthly-summary.md)
**Story ID:** US-6.1
**Priority:** Medium (P2)
**Status:** Draft

---

## Story

**As a** user,
**I want** to see a card with my total payments this month,
**so that** I can track my monthly bill spending.

---

## Acceptance Criteria

1. Summary card displayed on dashboard (prominent position)
2. Card shows current month name and year ("October 2025")
3. Displays total amount paid this month (sum of all PAID tasks in current month)
4. Amount formatted with currency: "฿4,850.00"
5. Count of bills paid this month: "5 bills paid"
6. Card styled distinctively (larger, highlighted, or separate section)
7. Updates automatically when task marked as paid
8. Shows ฿0.00 if no bills paid this month
9. Month calculation based on `task.paidAt` field

---

## Tasks / Subtasks

- [ ] Create MonthlySummaryCard component (AC: 1, 2, 6)
  - [ ] Create `components/summaries/MonthlySummaryCard.tsx`
  - [ ] Design card layout with prominent styling
  - [ ] Display current month name and year
  - [ ] Use React Server Component for data fetching

- [ ] Implement monthly payment calculation (AC: 3, 4, 5, 8, 9)
  - [ ] Create database query to fetch PAID tasks for current month
  - [ ] Filter tasks by `paidAt` field within current month boundaries
  - [ ] Calculate total sum of bill amounts
  - [ ] Count number of paid bills
  - [ ] Handle empty state (₿0.00, 0 bills)

- [ ] Add currency and number formatting (AC: 4, 5)
  - [ ] Format amount with ฿ symbol and 2 decimal places
  - [ ] Display bill count with proper singular/plural handling
  - [ ] Ensure consistent formatting with rest of app

- [ ] Integrate into dashboard (AC: 1, 6, 7)
  - [ ] Add MonthlySummaryCard to dashboard page
  - [ ] Position prominently above or near task lists
  - [ ] Ensure revalidation when tasks are marked paid
  - [ ] Apply distinctive styling (border, shadow, background)

- [ ] Handle edge cases and testing
  - [ ] Test with no paid tasks this month
  - [ ] Test with multiple paid tasks
  - [ ] Test month boundary calculations (timezone handling)
  - [ ] Verify updates when task status changes

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: Next.js React Server Components
- Database: Prisma ORM
- UI: Tailwind CSS for styling
- Date Utilities: date-fns for month calculations

**Integration Points:**
- Dashboard page: `app/(dashboard)/dashboard/page.tsx`
- Task payment data (Epic 4): Requires `paidAt` timestamp
- User data (Epic 9): Requires `userId` for filtering

**Database Query:**

```typescript
const startOfMonth = new Date(year, month, 1);
const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59);

const paidTasks = await prisma.task.findMany({
  where: {
    userId,
    status: 'PAID',
    paidAt: {
      gte: startOfMonth,
      lte: endOfMonth
    }
  },
  include: { bill: true }
});

const total = paidTasks.reduce((sum, task) => sum + Number(task.bill.amount), 0);
const count = paidTasks.length;
```

**Component Location:**
- Component: `components/summaries/MonthlySummaryCard.tsx`
- Service/Helper: Consider `lib/services/SummaryService.ts` for calculation logic

**Key Implementation Details:**
- Use server component for automatic data fetching
- Calculate month boundaries using date-fns
- Aggregate bill amounts from PAID tasks
- Format currency consistently with existing formatCurrency utility
- Handle timezone: Use user timezone (default Asia/Bangkok)

**Styling Guidelines:**
- Distinctive card design (larger than task cards)
- Consider using accent color or gradient background
- Clear visual hierarchy: month name → total amount → bill count
- Ensure responsive layout for mobile

**Performance Considerations:**
- Database index recommended: `(user_id, status, paid_at)`
- Consider caching summary data
- Use Prisma aggregation for better performance if needed

### Testing

**Test Location:** `__tests__/components/summaries/MonthlySummaryCard.test.tsx`

**Testing Standards:**
- Unit tests for calculation logic
- Component rendering tests with React Testing Library
- Integration tests for data fetching
- Edge case testing (empty state, month boundaries)

**Testing Frameworks:**
- Vitest for unit tests
- React Testing Library for component tests
- Mock Prisma client for database queries

**Specific Test Cases:**
1. Displays ฿0.00 when no bills paid this month
2. Calculates correct total for multiple paid bills
3. Shows correct bill count (singular/plural)
4. Displays current month name and year
5. Handles month boundary edge cases correctly
6. Updates when new task is marked paid (via revalidation)
7. Timezone handling for month calculations

**Mock Data Example:**
```typescript
const mockPaidTasks = [
  {
    id: '1',
    status: 'PAID',
    paidAt: new Date(2025, 9, 5), // Oct 5, 2025
    bill: { amount: 1500.00, vendor: 'Electric' }
  },
  {
    id: '2',
    status: 'PAID',
    paidAt: new Date(2025, 9, 15), // Oct 15, 2025
    bill: { amount: 850.00, vendor: 'Water' }
  }
];
// Expected total: ฿2,350.00, count: 2 bills
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created from Epic 6 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
