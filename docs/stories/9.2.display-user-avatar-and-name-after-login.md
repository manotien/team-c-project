# Story 9.2: Display User Avatar and Name After Login

**Epic:** EPIC-9 - Login & Authentication
**Story ID:** US-9.2
**Priority:** Critical (P0)
**Status:** Draft

---

## Story

**As a** user,
**I want** to see my avatar and name after login,
**so that** I know I'm logged in and the app recognizes me

---

## Acceptance Criteria

1. User avatar displayed in app header (top-right) after login
2. User name shown on hover/click of avatar (dropdown menu)
3. Avatar is circular image, sized appropriately (40px)
4. Avatar sourced from LINE profile picture
5. Name sourced from LINE display name
6. Fallback avatar if LINE profile has no picture:
   - Show first letter of name in colored circle
   - or default user icon
7. Logout button accessible from avatar dropdown
8. Click "Logout" clears session and returns to landing page
9. User data automatically updated on each login (name/avatar changes synced)

---

## Tasks / Subtasks

- [ ] Create Avatar component (AC: 3, 4, 6)
  - [ ] Build reusable Avatar component
  - [ ] Accept src (image URL) and name props
  - [ ] Display circular image (40px diameter)
  - [ ] Implement fallback: first letter of name in colored circle
  - [ ] Handle missing/broken image URLs
  - [ ] Apply appropriate styling and borders

- [ ] Create Header component (AC: 1)
  - [ ] Build Header layout component
  - [ ] Position avatar in top-right corner
  - [ ] Fetch user session on server side
  - [ ] Pass session data to Avatar component
  - [ ] Show header across all authenticated pages

- [ ] Implement avatar dropdown menu (AC: 2, 7)
  - [ ] Create DropdownMenu component
  - [ ] Trigger on avatar click/hover
  - [ ] Display user name as dropdown label
  - [ ] Add "Settings" menu item (optional)
  - [ ] Add "Logout" menu item
  - [ ] Style dropdown appropriately

- [ ] Implement logout functionality (AC: 8)
  - [ ] Import signOut from next-auth/react
  - [ ] Call signOut() on logout click
  - [ ] Configure callbackUrl to landing page
  - [ ] Clear session cookie
  - [ ] Redirect to landing page
  - [ ] Show logout confirmation (optional)

- [ ] Implement profile data sync (AC: 9)
  - [ ] Update user record on each login (US-9.1)
  - [ ] Fetch latest profile from LINE
  - [ ] Update name and avatarUrl in database
  - [ ] Reflect changes in session immediately

- [ ] Add session state management (AC: 1, 2)
  - [ ] Use getServerSession for server components
  - [ ] Use useSession for client components
  - [ ] Handle loading state while fetching session
  - [ ] Handle unauthenticated state gracefully

---

## Dev Notes

### Technical Context

**Tech Stack:**
- Frontend: Next.js (Server Components + Client Components)
- Auth: NextAuth.js session management
- UI Components: Custom Avatar and Dropdown components
- Styling: Tailwind CSS / CSS Modules

**Integration Points:**
- US-9.1: Depends on authentication and session
- Epic 8 (US-8.1): Avatar component reused for bill type icons
- All authenticated pages: Header component displayed

**Key Implementation Details:**

**Session Data Structure:**
```typescript
session.user = {
  id: string;          // User UUID from database
  name: string;        // LINE display name
  email?: string;      // Not used for LINE OAuth
  image: string;       // LINE profile picture URL
}
```

**Header Component (`components/layout/Header.tsx`):**
```typescript
import { getServerSession } from 'next-auth';
import { Avatar } from '@/components/ui/Avatar';
import { authOptions } from '@/lib/auth';

export async function Header() {
  const session = await getServerSession(authOptions);

  if (!session) {
    return (
      <header>
        <Link href="/login">Login with LINE</Link>
      </header>
    );
  }

  return (
    <header>
      <nav>
        <Link href="/dashboard">Dashboard</Link>
        {/* other nav items */}
      </nav>

      <DropdownMenu>
        <DropdownMenuTrigger>
          <Avatar
            src={session.user.image}
            name={session.user.name}
          />
        </DropdownMenuTrigger>
        <DropdownMenuContent>
          <DropdownMenuLabel>{session.user.name}</DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuItem>Settings</DropdownMenuItem>
          <DropdownMenuItem onClick={() => signOut()}>
            Logout
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </header>
  );
}
```

**Avatar Component (`components/ui/Avatar.tsx`):**
```typescript
interface AvatarProps {
  src?: string | null;
  name: string;
  size?: number; // default 40px
}

export function Avatar({ src, name, size = 40 }: AvatarProps) {
  const [error, setError] = useState(false);

  if (!src || error) {
    // Fallback: show first letter in colored circle
    const initial = name.charAt(0).toUpperCase();
    const bgColor = getColorFromName(name); // Generate consistent color

    return (
      <div
        className="avatar-fallback"
        style={{
          width: size,
          height: size,
          backgroundColor: bgColor,
          borderRadius: '50%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: 'white',
          fontSize: size / 2,
          fontWeight: 'bold'
        }}
      >
        {initial}
      </div>
    );
  }

  return (
    <img
      src={src}
      alt={name}
      width={size}
      height={size}
      className="avatar-image"
      style={{ borderRadius: '50%', objectFit: 'cover' }}
      onError={() => setError(true)}
    />
  );
}
```

**Logout Implementation:**
```typescript
'use client';

import { signOut } from 'next-auth/react';

function LogoutButton() {
  const handleLogout = () => {
    signOut({ callbackUrl: '/' });
  };

  return <button onClick={handleLogout}>Logout</button>;
}
```

**Profile Data Sync:**
- Handled in US-9.1 signIn callback
- Updates user name and avatarUrl on each login
- No additional implementation needed

**Color Generation for Fallback:**
```typescript
function getColorFromName(name: string): string {
  // Generate consistent color based on name
  const colors = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
    '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'
  ];

  const hash = name.split('').reduce((acc, char) => {
    return acc + char.charCodeAt(0);
  }, 0);

  return colors[hash % colors.length];
}
```

### Dependencies

**Upstream Dependencies:**
- US-9.1: Must be completed first (authentication and session)

**Downstream Dependencies:**
- Epic 8 (US-8.1): Avatar component can be reused for bill type icons

### Testing

**Test Location:** `__tests__/components/layout/` and `__tests__/components/ui/`

**Testing Standards:**
- Unit tests for Avatar component
- Unit tests for Header component
- Integration test for logout flow
- E2E test for authenticated user experience
- Visual regression tests for avatar display

**Testing Frameworks:**
- Jest for unit tests
- React Testing Library for component tests
- Playwright/Cypress for E2E tests
- Mock NextAuth session

**Specific Requirements:**
- Test Avatar with valid image URL
- Test Avatar with broken image URL (fallback)
- Test Avatar with no image URL (fallback)
- Test fallback shows correct initial
- Test fallback color generation
- Test Header with authenticated session
- Test Header with unauthenticated session
- Test dropdown menu opens on click
- Test dropdown displays user name
- Test logout button click
- Test logout clears session
- Test logout redirects to landing page
- Mock getServerSession for server components
- Mock useSession for client components

**Test Scenarios:**
1. **Avatar with image**: Display LINE profile picture
2. **Avatar without image**: Show first letter fallback
3. **Broken image URL**: Gracefully fallback to letter
4. **Dropdown interaction**: Click avatar → show menu → click logout
5. **Logout flow**: Click logout → clear session → redirect to landing
6. **Profile update**: Login again → new avatar/name reflected
7. **Consistent fallback color**: Same name → same color

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

---

## QA Results

_To be populated by QA agent_
