# US-4.1: Mark Task as Paid

**Story ID:** US-4.1
**Epic:** [Epic 4: Task Actions & History](epic-4-task-actions-history.md)
**Priority:** Critical (P0)
**Story Points:** 3
**Status:** Ready for Development

---

## User Story

**As a** user
**I want to** mark a task as Paid
**So that** it moves off my active task list and shows as completed

---

## Acceptance Criteria

- [ ] "Mark as Paid" button visible on task detail page (when status = UNPAID)
- [ ] Click button opens confirmation dialog or modal
- [ ] Confirmation shows:
  - [ ] Bill vendor name and amount
  - [ ] "Are you sure you want to mark this as paid?"
  - [ ] Cancel and Confirm buttons
- [ ] Confirm button triggers API: `PATCH /api/tasks/:id { status: 'PAID' }`
- [ ] Task status updated to PAID in database
- [ ] `paidAt` timestamp set to current time
- [ ] Success message: "Task marked as paid"
- [ ] Task removed from "Upcoming Tasks" section
- [ ] Task appears in "Completed Tasks" history
- [ ] Optimistic UI update (instant visual feedback)

---

## Technical Implementation

### Backend API

**File:** `app/api/tasks/[id]/route.ts`

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

export async function GET(
  req: Request,
  { params }: { params: { id: string } }
) {
  const session = await getServerSession(authOptions);

  if (!session?.user?.id) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const task = await prisma.task.findUnique({
    where: {
      id: params.id,
      userId: session.user.id, // Ensure user owns task
    },
    include: {
      bill: true,
    },
  });

  if (!task) {
    return NextResponse.json({ error: "Task not found" }, { status: 404 });
  }

  return NextResponse.json(task);
}

export async function PATCH(
  req: Request,
  { params }: { params: { id: string } }
) {
  const session = await getServerSession(authOptions);

  if (!session?.user?.id) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const body = await req.json();
  const { status, paymentProofUrl } = body;

  // Validate status
  if (status && !["UNPAID", "PAID"].includes(status)) {
    return NextResponse.json({ error: "Invalid status" }, { status: 400 });
  }

  // Build update data
  const updateData: any = {};
  if (status) {
    updateData.status = status;
    if (status === "PAID") {
      updateData.paidAt = new Date();
    }
  }
  if (paymentProofUrl !== undefined) {
    updateData.paymentProofUrl = paymentProofUrl;
  }

  try {
    const task = await prisma.task.update({
      where: {
        id: params.id,
        userId: session.user.id, // Ensure user owns task
      },
      data: updateData,
      include: {
        bill: true,
      },
    });

    return NextResponse.json({
      message: status === "PAID" ? "Task marked as paid" : "Task updated",
      task,
    });
  } catch (error) {
    console.error("Error updating task:", error);
    return NextResponse.json(
      { error: "Failed to update task" },
      { status: 500 }
    );
  }
}
```

### Frontend Components

**File:** `components/tasks/MarkPaidButton.tsx`

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import ConfirmDialog from "@/components/ui/ConfirmDialog";
import { formatCurrency } from "@/lib/utils";

interface MarkPaidButtonProps {
  task: {
    id: string;
    status: string;
    bill: {
      vendor: string;
      amount: number;
    };
  };
}

export default function MarkPaidButton({ task }: MarkPaidButtonProps) {
  const router = useRouter();
  const [isOpen, setIsOpen] = useState(false);
  const [loading, setLoading] = useState(false);

  if (task.status === "PAID") {
    return null; // Don't show button if already paid
  }

  async function handleConfirm() {
    setLoading(true);

    try {
      const response = await fetch(`/api/tasks/${task.id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          status: "PAID",
        }),
      });

      if (!response.ok) {
        throw new Error("Failed to mark task as paid");
      }

      const data = await response.json();

      // Show success message (toast notification)
      alert(data.message || "Task marked as paid");

      // Refresh the page to show updated data
      router.refresh();
      setIsOpen(false);
    } catch (error) {
      console.error("Error marking task as paid:", error);
      alert("Failed to mark task as paid. Please try again.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <>
      <button
        onClick={() => setIsOpen(true)}
        className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
      >
        Mark as Paid
      </button>

      <ConfirmDialog
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
        onConfirm={handleConfirm}
        loading={loading}
        title="Mark Task as Paid"
        message={
          <>
            <p>Are you sure you want to mark this task as paid?</p>
            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
              <p className="font-semibold">{task.bill.vendor}</p>
              <p className="text-xl font-bold text-green-600 mt-1">
                {formatCurrency(task.bill.amount)}
              </p>
            </div>
          </>
        }
        confirmText="Confirm"
        cancelText="Cancel"
      />
    </>
  );
}
```

**File:** `components/ui/ConfirmDialog.tsx`

```typescript
"use client";

import { ReactNode } from "react";

interface ConfirmDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  loading?: boolean;
  title: string;
  message: ReactNode;
  confirmText?: string;
  cancelText?: string;
}

export default function ConfirmDialog({
  isOpen,
  onClose,
  onConfirm,
  loading = false,
  title,
  message,
  confirmText = "Confirm",
  cancelText = "Cancel",
}: ConfirmDialogProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />

      {/* Dialog */}
      <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <h2 className="text-xl font-bold mb-4">{title}</h2>
        <div className="mb-6">{message}</div>

        <div className="flex gap-3 justify-end">
          <button
            onClick={onClose}
            disabled={loading}
            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
          >
            {cancelText}
          </button>
          <button
            onClick={onConfirm}
            disabled={loading}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
          >
            {loading ? "Processing..." : confirmText}
          </button>
        </div>
      </div>
    </div>
  );
}
```

### Task Detail Page (with Mark Paid Button)

**File:** `app/(dashboard)/tasks/[id]/page.tsx`

```typescript
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { prisma } from "@/lib/prisma";
import { redirect } from "next/navigation";
import MarkPaidButton from "@/components/tasks/MarkPaidButton";
import { formatCurrency, formatDate } from "@/lib/utils";
import { getBillTypeIcon } from "@/lib/billTypes";

export default async function TaskDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const session = await getServerSession(authOptions);

  if (!session?.user?.id) {
    redirect("/login");
  }

  const task = await prisma.task.findUnique({
    where: {
      id: params.id,
      userId: session.user.id,
    },
    include: {
      bill: true,
    },
  });

  if (!task) {
    return <div>Task not found</div>;
  }

  const statusColor =
    task.status === "PAID"
      ? "bg-green-100 text-green-700"
      : "bg-yellow-100 text-yellow-700";

  return (
    <div className="container mx-auto p-6 max-w-2xl">
      {/* Header */}
      <div className="mb-6">
        <div className="flex items-center gap-2 mb-2">
          <span className="text-4xl">{getBillTypeIcon(task.bill.type)}</span>
          <h1 className="text-3xl font-bold">{task.bill.vendor}</h1>
        </div>
        <span
          className={`inline-block px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}
        >
          {task.status}
        </span>
      </div>

      {/* Bill Details */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <div className="space-y-4">
          <div>
            <p className="text-sm text-gray-600">Amount</p>
            <p className="text-3xl font-bold text-blue-600">
              {formatCurrency(task.bill.amount)}
            </p>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <p className="text-sm text-gray-600">Due Date</p>
              <p className="font-semibold">{formatDate(task.dueDate)}</p>
            </div>

            {task.paidAt && (
              <div>
                <p className="text-sm text-gray-600">Paid Date</p>
                <p className="font-semibold">{formatDate(task.paidAt)}</p>
              </div>
            )}
          </div>

          <div>
            <p className="text-sm text-gray-600">Bill Type</p>
            <p className="font-semibold capitalize">{task.bill.type}</p>
          </div>
        </div>
      </div>

      {/* Mark Paid Button */}
      <MarkPaidButton task={task} />

      {/* Back Button */}
      <div className="mt-4">
        <a
          href="/dashboard"
          className="text-blue-600 hover:text-blue-700 underline"
        >
          ← Back to Dashboard
        </a>
      </div>
    </div>
  );
}
```

---

## Technical Notes

- **API Route:** `app/api/tasks/[id]/route.ts`
- **Update Query:** `prisma.task.update({ where: { id }, data: { status: 'PAID', paidAt: new Date() } })`
- **Optimistic UI:** Use `router.refresh()` to reload server component data
- **Security:** Verify user owns task before allowing update
- **Validation:** Ensure status is valid enum value

---

## Dependencies

**Upstream:**

- Epic 2 US-2.1: Tasks must exist to be marked as paid
- Epic 4 US-4.4: Task detail page displays the button

**Downstream:**

- Epic 4 US-4.3: Paid tasks appear in history
- Epic 6 (Monthly Summary): Paid tasks included in calculations
- Epic 3 US-3.2: Scheduled notifications cancelled when task marked paid

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] API endpoint implemented and tested
- [ ] Confirmation dialog functional
- [ ] Task status updates correctly
- [ ] paidAt timestamp set
- [ ] Success message displayed
- [ ] Task removed from upcoming tasks
- [ ] Optimistic UI update working
- [ ] User ownership validation enforced
- [ ] Unit tests passing
- [ ] E2E tests passing
- [ ] Code reviewed and merged

---

## UI/UX Design

### Task Detail Page (Unpaid)

```
┌─────────────────────────────────────┐
│  ⚡ Internet Bill                   │
│  [UNPAID]                           │
│                                     │
│  Amount:                            │
│  ฿1,500.00                          │
│                                     │
│  Due Date: Oct 15, 2025             │
│                                     │
│  ┌─────────────────────────────┐   │
│  │   Mark as Paid              │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### Confirmation Dialog

```
┌─────────────────────────────────────┐
│  Mark Task as Paid                  │
│                                     │
│  Are you sure you want to mark      │
│  this task as paid?                 │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ Internet Bill                 │ │
│  │ ฿1,500.00                     │ │
│  └───────────────────────────────┘ │
│                                     │
│      [Cancel]     [Confirm]         │
└─────────────────────────────────────┘
```

---

## Accessibility

- [ ] Button has clear label and aria attributes
- [ ] Dialog has proper focus management
- [ ] Keyboard navigation (Tab, Enter, Esc)
- [ ] Screen reader announcements for status change
- [ ] Sufficient color contrast for status badges

---

## Performance Considerations

- **Optimistic Updates:** Use `router.refresh()` for instant feedback
- **Database Index:** Index on `status` for fast filtering
- **Validation:** Client-side validation before API call
- **Error Handling:** Clear error messages for network failures

---

## Notes

- **Critical path** for 4-hour MVP demo
- Keep UI simple and intuitive
- Confirmation prevents accidental marking
- No "undo" functionality in MVP (future enhancement)
- Single-user architecture - no need to track "who paid"
